<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Diagnóstico de Autenticación</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .status-ok { color: green; }
    .status-error { color: red; }
    .status-warning { color: orange; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h1>Diagnóstico de Autenticación</h1>
    
    <div class="card mb-3">
      <div class="card-header">1. Estado de localStorage</div>
      <div class="card-body">
        <table class="table table-sm">
          <tr>
            <td>authToken:</td>
            <td id="check-authToken"></td>
          </tr>
          <tr>
            <td>token:</td>
            <td id="check-token"></td>
          </tr>
          <tr>
            <td>usuario_email:</td>
            <td id="check-email"></td>
          </tr>
          <tr>
            <td>usuario_roles:</td>
            <td id="check-roles"></td>
          </tr>
        </table>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header">2. Probar endpoint de perfil</div>
      <div class="card-body">
        <button class="btn btn-primary" onclick="probarPerfil()">Probar API</button>
        <pre id="resultado-api" class="mt-3 p-3 bg-light" style="min-height: 100px;"></pre>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header">3. Acciones</div>
      <div class="card-body">
        <button class="btn btn-warning" onclick="limpiarStorage()">Limpiar localStorage</button>
        <a href="modules/GestionUsuarios/Views/login.html" class="btn btn-success">Ir a Login</a>
        <a href="modules/CatalogoProductos/Views/impuestos_admin.html" class="btn btn-info">Ir a Impuestos Admin</a>
      </div>
    </div>
  </div>

  <script>
    // Verificar localStorage
    function verificarStorage() {
      const authToken = localStorage.getItem('authToken');
      const token = localStorage.getItem('token');
      const email = localStorage.getItem('usuario_email');
      const roles = localStorage.getItem('usuario_roles');

      document.getElementById('check-authToken').innerHTML = authToken 
        ? `<span class="status-ok">✓ ${authToken.substring(0, 20)}...</span>` 
        : '<span class="status-error">✗ No encontrado</span>';

      document.getElementById('check-token').innerHTML = token 
        ? `<span class="status-ok">✓ ${token.substring(0, 20)}...</span>` 
        : '<span class="status-error">✗ No encontrado</span>';

      document.getElementById('check-email').innerHTML = email 
        ? `<span class="status-ok">✓ ${email}</span>` 
        : '<span class="status-error">✗ No encontrado</span>';

      document.getElementById('check-roles').innerHTML = roles 
        ? `<span class="status-ok">✓ ${roles}</span>` 
        : '<span class="status-error">✗ No encontrado</span>';
    }

    // Probar API
    async function probarPerfil() {
      const resultado = document.getElementById('resultado-api');
      resultado.textContent = 'Consultando...';

      const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
      
      if (!authToken) {
        resultado.textContent = 'ERROR: No hay token en localStorage. Debes hacer login primero.';
        return;
      }

      try {
        const response = await fetch('/modules/GestionUsuarios/Api/index.php?action=perfil', {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        resultado.textContent = `Status: ${response.status}\n\n${JSON.stringify(data, null, 2)}`;

        // Análisis
        if (response.status === 200 && data.datos && data.datos.usuario) {
          const usuario = data.datos.usuario;
          resultado.textContent += '\n\n=== ANÁLISIS ===\n';
          resultado.textContent += `Email: ${usuario.email}\n`;
          resultado.textContent += `Nombre: ${usuario.nombre_completo}\n`;
          resultado.textContent += `Roles: ${usuario.roles}\n`;
          resultado.textContent += `Estado ID: ${usuario.estado_id} ${usuario.estado_id === 1 ? '✓' : '✗'}\n`;
          resultado.textContent += `Activo: ${usuario.activo} ${usuario.activo === 1 ? '✓' : '✗'}\n`;
          
          const rolesArray = usuario.roles.split(',').map(r => r.trim());
          const tieneAcceso = rolesArray.includes('ADMINISTRADOR') || rolesArray.includes('GESTOR_CONTENIDOS');
          resultado.textContent += `\nAcceso a impuestos_admin: ${tieneAcceso ? '✓ PERMITIDO' : '✗ DENEGADO'}\n`;
          resultado.textContent += `Roles requeridos: ADMINISTRADOR o GESTOR_CONTENIDOS\n`;
          resultado.textContent += `Roles del usuario: ${rolesArray.join(', ')}\n`;
        }

      } catch (error) {
        resultado.textContent = `ERROR: ${error.message}`;
      }
    }

    // Limpiar storage
    function limpiarStorage() {
      if (confirm('¿Estás seguro? Esto borrará toda la sesión.')) {
        localStorage.clear();
        alert('localStorage limpiado. Recarga la página.');
        location.reload();
      }
    }

    // Ejecutar al cargar
    verificarStorage();
  </script>
</body>
</html>
