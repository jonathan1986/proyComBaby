<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin: Impuestos</title>
  <link rel="icon" href="data:,">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../../Shared/Assets/css/layout.css">
  <style>
    body { padding: 16px; }
    .table-fixed thead th { position: sticky; top: 0; background: #fff; z-index: 1; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    #accessDenied { display: none; }
  </style>
  </head>
<body>
  <!-- Incluir sidebar y topbar -->
  <div id="layoutContainer"></div>

  <!-- Mensaje de acceso restringido -->
  <div id="accessDenied" class="container mt-5">
    <div class="alert alert-danger text-center">
      <h4>⚠️ Acceso Restringido</h4>
      <p>No tienes permisos para acceder a esta página.</p>
      <p>Roles requeridos: <strong>ADMINISTRADOR</strong> o <strong>GESTOR_CONTENIDOS</strong></p>
      <a href="../../GestionUsuarios/Views/login.html" class="btn btn-primary mt-3">Ir a Login</a>
    </div>
  </div>

  <div class="container-fluid" id="mainContent" style="display: none;">
    <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
      <h1 class="h4 m-0">Administración de Impuestos</h1>
      <div class="d-flex gap-2">
        <span id="userInfo" class="text-muted small"></span>
        <a href="catalogo_productos.html" class="btn btn-outline-secondary btn-sm">Volver al catálogo</a>
        <button class="btn btn-outline-danger btn-sm" id="btnLogout">Cerrar Sesión</button>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-header">Catálogo de impuestos</div>
          <div class="card-body">
            <form id="frmImp" class="row g-2">
              <div class="col-4">
                <label class="form-label small">Código</label>
                <input type="text" id="imp_codigo" class="form-control form-control-sm" required />
              </div>
              <div class="col-8">
                <label class="form-label small">Nombre</label>
                <input type="text" id="imp_nombre" class="form-control form-control-sm" required />
              </div>
              <div class="col-4">
                <label class="form-label small">Tipo</label>
                <select id="imp_tipo" class="form-select form-select-sm">
                  <option value="porcentaje">porcentaje</option>
                  <option value="fijo">fijo</option>
                </select>
              </div>
              <div class="col-4">
                <label class="form-label small">Valor</label>
                <input type="number" step="0.0001" id="imp_valor" class="form-control form-control-sm" value="18.00" />
              </div>
              <div class="col-4">
                <label class="form-label small">Aplica sobre</label>
                <select id="imp_aplica" class="form-select form-select-sm">
                  <option value="base_descuento">base_descuento</option>
                  <option value="subtotal">subtotal</option>
                </select>
              </div>
              <div class="col-4">
                <label class="form-label small">Activo</label>
                <select id="imp_activo" class="form-select form-select-sm">
                  <option value="1">Sí</option>
                  <option value="0">No</option>
                </select>
              </div>
              <div class="col-8 d-grid">
                <button class="btn btn-success btn-sm" type="submit">Crear impuesto</button>
              </div>
            </form>
            <hr/>
            <div class="table-responsive">
              <table class="table table-sm table-striped table-hover table-fixed">
                <thead><tr><th>ID</th><th>Código</th><th>Nombre</th><th>Tipo</th><th>Valor</th><th>Activo</th><th></th></tr></thead>
                <tbody id="imp_tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-header">Asignación de impuestos por producto</div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label small">Buscar producto</label>
              <div class="d-flex gap-2 align-items-end flex-wrap">
                <input type="text" id="pi_buscar" class="form-control form-control-sm" placeholder="Nombre o término" style="max-width:320px;" />
                <button class="btn btn-outline-primary btn-sm" id="btnBuscarProd" type="button">Buscar</button>
              </div>
              <div class="table-responsive mt-2" id="pi_results_wrap" style="display:none;">
                <table class="table table-sm table-striped table-hover table-fixed">
                  <thead><tr><th>ID</th><th>Nombre</th><th>Precio</th><th></th></tr></thead>
                  <tbody id="pi_results"></tbody>
                </table>
              </div>
            </div>
            <form id="frmProdImp" class="row g-2 align-items-end">
              <div class="col-6">
                <label class="form-label small">Producto</label>
                <input type="text" id="pi_producto_empty" class="form-control form-control-sm" placeholder="No seleccionado" readonly />
                <input type="hidden" id="pi_id_producto" required />
                <input type="hidden" id="pi_nombre_producto" />
              </div>
              <div class="col-6">
                <label class="form-label small">Impuesto</label>
                <select id="pi_sel_impuesto" class="form-select form-select-sm" required>
                  <option value="">(selecciona)</option>
                </select>
              </div>
              <div class="col-12 d-flex gap-2">
                <button class="btn btn-success btn-sm" type="submit">Asignar</button>
                <button class="btn btn-outline-danger btn-sm" type="button" id="btnDelPI">Quitar</button>
              </div>
            </form>
            <hr/>
            <!-- Asignación masiva: productos NO asignados al impuesto seleccionado -->
            <div class="mb-2">
              <div class="d-flex flex-wrap align-items-end gap-2">
                <div>
                  <label class="form-label small">Impuesto seleccionado</label>
                  <select id="pi_sel_impuesto_bulk" class="form-select form-select-sm" style="min-width:240px;">
                    <option value="">(selecciona un impuesto)</option>
                  </select>
                </div>
                <button class="btn btn-sm btn-outline-primary" type="button" id="btnCargarNoAsignados">Cargar no asignados</button>
                <button class="btn btn-sm btn-success" type="button" id="btnBulkAssign" disabled>Asignar a seleccionados</button>
              </div>
            </div>
            <div class="table-responsive" id="bulk_wrap" style="display:none;">
              <table class="table table-sm table-striped table-hover table-fixed">
                <thead>
                  <tr>
                    <th style="width:36px;"><input type="checkbox" id="bulk_sel_all"></th>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Precio</th>
                  </tr>
                </thead>
                <tbody id="bulk_tbody"></tbody>
              </table>
            </div>
            <hr/>
            <div class="d-flex gap-2 align-items-end mb-2">
              <div>
                <label class="form-label small">Ver asignaciones de producto</label>
                <input type="number" id="pi_ver_producto" class="form-control form-control-sm" placeholder="ID producto" />
              </div>
              <button class="btn btn-primary btn-sm" id="btnVerPI">Ver</button>
            </div>
            <div class="table-responsive">
              <table class="table table-sm table-striped table-hover table-fixed">
                <thead><tr><th>ID Impuesto</th><th>Código</th><th>Nombre</th><th>Tipo</th><th>Valor</th></tr></thead>
                <tbody id="pi_tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function escapeHTML(s){return (s??'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

    // La autenticación ahora se maneja en layout.js
    const ROLES_PERMITIDOS = ['ADMINISTRADOR', 'GESTOR_CONTENIDOS'];
    let authToken = localStorage.getItem('authToken');
    
    // Cargar impuestos después de inicializar el layout
    window.addEventListener('load', async () => {
      // Esperar a que initLayout termine
      setTimeout(async () => {
        if (typeof loadImpuestos !== 'undefined') {
          await loadImpuestos();
        }
      }, 500);
    });

    // ==================== CONFIGURACIÓN DE API ====================

    (function initBase(){
      const p = location.pathname.replace(/\\/g,'/');
      const marker = '/modules/CatalogoProductos/Views/';
      const idx = p.indexOf(marker);
      window.CATALOGO_BASE = idx!==-1 ? p.substring(0, idx+1)+'modules/CatalogoProductos/' : '/modules/CatalogoProductos/';
    })();
    
    const API = {
      impuestos: window.CATALOGO_BASE + 'Controllers/impuestos_api.php',
      prodImp: window.CATALOGO_BASE + 'Controllers/productos_impuestos_api.php',
      producto: window.CATALOGO_BASE + 'Controllers/producto_api.php'
    };

    // Headers con autenticación Bearer y token de mantenimiento
    function authHeaders(){
      return {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json',
        'X-Maint-Token': 'changeme-strong-token'
      };
    }

    async function apiGet(url){
      const r = await fetch(url, { headers: authHeaders() });
      const txt = await r.text();
      let j; try { j = JSON.parse(txt); } catch { j = null; }
      if (!r.ok) {
        if (r.status === 401 || r.status === 403) {
          alert('Sesión expirada o sin permisos. Redirigiendo a login...');
          localStorage.removeItem('authToken');
          window.location.href = '../../GestionUsuarios/Views/login.html';
          throw new Error('No autorizado');
        }
        throw new Error(j?.error || txt || ('HTTP '+r.status));
      }
      if (j?.success === false) throw new Error(j.error || 'Error');
      return j ?? {};
    }
    
    async function apiSend(url, method, body){
      const r = await fetch(url, { method, headers: authHeaders(), body: JSON.stringify(body) });
      const txt = await r.text();
      let j; try { j = JSON.parse(txt); } catch { j = null; }
      if (!r.ok) {
        if (r.status === 401 || r.status === 403) {
          alert('Sesión expirada o sin permisos. Redirigiendo a login...');
          localStorage.removeItem('authToken');
          window.location.href = '../../GestionUsuarios/Views/login.html';
          throw new Error('No autorizado');
        }
        throw new Error(j?.error || txt || ('HTTP '+r.status));
      }
      if (j?.success === false) throw new Error(j.error || 'Error');
      return j ?? {};
    }

    // Catálogo: listar
    async function loadImpuestos(){
      try{
        const data = await apiGet(API.impuestos);
        const tbody = document.getElementById('imp_tbody');
        tbody.innerHTML = (data.impuestos||[]).map(x=>`<tr>
          <td>${escapeHTML(x.id_impuesto)}</td>
          <td class="code">${escapeHTML(x.codigo)}</td>
          <td>${escapeHTML(x.nombre)}</td>
          <td>${escapeHTML(x.tipo)}</td>
          <td>${escapeHTML(x.valor)}</td>
          <td>${x.activo ? 'Sí' : 'No'}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-primary" data-edit="${escapeHTML(x.id_impuesto)}">Editar</button>
            <button class="btn btn-sm btn-outline-danger" data-del="${escapeHTML(x.id_impuesto)}">Borrar</button>
          </td>
        </tr>`).join('');
        // Poblar selector para asignación
        const sel = document.getElementById('pi_sel_impuesto');
        const cur = sel.value;
        sel.innerHTML = '<option value="">(selecciona)</option>' + (data.impuestos||[]).map(x=>`<option value="${escapeHTML(x.id_impuesto)}">${escapeHTML(x.codigo)} - ${escapeHTML(x.nombre)}</option>`).join('');
        // Mantener selección previa si coincide
        if ([...sel.options].some(o=>o.value===cur)) sel.value = cur;

        // Poblar selector para asignación masiva (solo nombres)
        const selBulk = document.getElementById('pi_sel_impuesto_bulk');
        const curB = selBulk.value;
        selBulk.innerHTML = '<option value="">(selecciona un impuesto)</option>' + (data.impuestos||[]).map(x=>`<option value="${escapeHTML(x.id_impuesto)}">${escapeHTML(x.nombre)}</option>`).join('');
        if ([...selBulk.options].some(o=>o.value===curB)) selBulk.value = curB;
      }catch(e){ alert('Error listando impuestos: '+e.message); }
    }

    // ===== Asignación masiva =====
    async function cargarNoAsignados(){
      const idImp = document.getElementById('pi_sel_impuesto_bulk').value || document.getElementById('pi_sel_impuesto').value;
      if (!idImp) { alert('Selecciona un impuesto'); return; }
      try {
        // 1) Productos asignados a este impuesto
        const u1 = new URL(API.prodImp, location.origin); u1.searchParams.set('id_impuesto', idImp);
        const asg = await apiGet(u1);
        const asignados = new Set((asg.productos||[]).map(p=>String(p.id_producto)));
        // 2) Listar productos (puedes cambiar a paginado si son muchos)
        const u2 = new URL(API.producto, location.origin); u2.searchParams.set('listar','1');
        const all = await apiGet(u2);
        const productos = (all.productos||[]);
        const noAsig = productos.filter(p => !asignados.has(String(p.id_producto)));
        const tbody = document.getElementById('bulk_tbody');
        const wrap = document.getElementById('bulk_wrap');
        if (!noAsig.length) {
          wrap.style.display = '';
          tbody.innerHTML = '<tr><td colspan="4" class="text-muted">Todos los productos ya tienen este impuesto.</td></tr>';
          document.getElementById('btnBulkAssign').disabled = true;
          (document.getElementById('bulk_sel_all')||{}).checked = false;
          return;
        }
        wrap.style.display = '';
        tbody.innerHTML = noAsig.map(p=>`<tr>
          <td><input type="checkbox" class="bulk_sel" data-id="${escapeHTML(p.id_producto)}"></td>
          <td>${escapeHTML(p.id_producto)}</td>
          <td>${escapeHTML(p.nombre||'')}</td>
          <td>${escapeHTML(p.precio||'')}</td>
        </tr>`).join('');
        document.getElementById('btnBulkAssign').disabled = false;
        (document.getElementById('bulk_sel_all')||{}).checked = false;
      } catch(err) {
        alert('Error cargando no asignados: '+err.message);
      }
    }

    document.getElementById('btnCargarNoAsignados').addEventListener('click', cargarNoAsignados);
    document.getElementById('bulk_sel_all').addEventListener('change', (e)=>{
      const ck = e.target.checked;
      document.querySelectorAll('#bulk_tbody .bulk_sel').forEach(ch => ch.checked = ck);
    });
    document.getElementById('btnBulkAssign').addEventListener('click', async ()=>{
      const idImp = document.getElementById('pi_sel_impuesto_bulk').value || document.getElementById('pi_sel_impuesto').value;
      if (!idImp) { alert('Selecciona un impuesto'); return; }
      const ids = Array.from(document.querySelectorAll('#bulk_tbody .bulk_sel:checked')).map(ch=>ch.getAttribute('data-id'));
      if (!ids.length) { alert('Selecciona al menos un producto'); return; }
      try {
        // Ejecutar en paralelo (con cuidado por rate limit si lo hay)
        await Promise.all(ids.map(idp => apiSend(API.prodImp, 'POST', { id_producto: parseInt(idp,10), id_impuesto: parseInt(idImp,10) })));
        alert('Impuesto asignado a seleccionados');
        cargarNoAsignados(); // refrescar lista
      } catch(err) {
        alert('Error en asignación masiva: '+err.message);
      }
    });

    // Crear
    document.getElementById('frmImp').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = {
        codigo: document.getElementById('imp_codigo').value.trim(),
        nombre: document.getElementById('imp_nombre').value.trim(),
        tipo: document.getElementById('imp_tipo').value,
        valor: parseFloat(document.getElementById('imp_valor').value||'0'),
        aplica_sobre: document.getElementById('imp_aplica').value,
        activo: parseInt(document.getElementById('imp_activo').value,10)
      };
      try { await apiSend(API.impuestos, 'POST', payload); await loadImpuestos(); } catch(e){ alert('Error creando: '+e.message); }
    });

    // Delegación: editar / borrar
    document.addEventListener('click', async (e)=>{
      const btnDel = e.target.closest('[data-del]');
      if(btnDel){
        if(!confirm('¿Eliminar impuesto?')) return;
        const id = btnDel.getAttribute('data-del');
        try{ 
          const u = new URL(API.impuestos, location.origin); 
          u.searchParams.set('id', id);
          const r = await fetch(u, { method:'DELETE', headers: authHeaders() });
          const txt = await r.text();
          let j; try { j = JSON.parse(txt); } catch { j = null; }
          if (!r.ok) {
            if (r.status === 401 || r.status === 403) {
              alert('Sesión expirada o sin permisos. Redirigiendo a login...');
              localStorage.removeItem('authToken');
              window.location.href = '../../GestionUsuarios/Views/login.html';
              return;
            }
            throw new Error(j?.error || txt || ('HTTP '+r.status));
          }
          await loadImpuestos();
        }catch(err){ alert('Error eliminando: '+err.message); }
        return;
      }
      const btnEd = e.target.closest('[data-edit]');
      if(btnEd){
        const id = btnEd.getAttribute('data-edit');
        const nombre = prompt('Nuevo nombre (deja vacío para no cambiar)');
        const valor = prompt('Nuevo valor (deja vacío para no cambiar)');
        const activo = prompt('Activo? 1=Sí, 0=No (deja vacío para no cambiar)');
        const payload = {};
        if (nombre) payload.nombre = nombre;
        if (valor!==null && valor!=='') payload.valor = parseFloat(valor);
        if (activo!==null && activo!=='') payload.activo = parseInt(activo,10);
        if (Object.keys(payload).length===0) return;
        try{ 
          const u = API.impuestos + '?id=' + id;
          const r = await fetch(u, { 
            method: 'PATCH', 
            headers: authHeaders(), 
            body: JSON.stringify(payload) 
          });
          const txt = await r.text();
          let j; try { j = JSON.parse(txt); } catch { j = null; }
          if (!r.ok) {
            if (r.status === 401 || r.status === 403) {
              alert('Sesión expirada o sin permisos. Redirigiendo a login...');
              localStorage.removeItem('authToken');
              window.location.href = '../../GestionUsuarios/Views/login.html';
              return;
            }
            throw new Error(j?.error || txt || ('HTTP '+r.status));
          }
          if (j?.success === false) throw new Error(j.error || 'Error');
          await loadImpuestos(); 
        }
        catch(err){ alert('Error actualizando: '+err.message); }
      }
    });

    // Asignaciones producto-impuesto
    document.getElementById('frmProdImp').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const idImpuesto = document.getElementById('pi_sel_impuesto').value;
      if (!idImpuesto) {
        alert('Selecciona un impuesto');
        return;
      }
      const payload = {
        id_producto: parseInt(document.getElementById('pi_id_producto').value,10),
        id_impuesto: parseInt(idImpuesto,10)
      };
      try{ await apiSend(API.prodImp, 'POST', payload); await verAsignaciones(); }
      catch(err){ alert('Error asignando: '+err.message); }
    });

    document.getElementById('btnDelPI').addEventListener('click', async ()=>{
      const p = document.getElementById('pi_id_producto').value;
      const i = document.getElementById('pi_sel_impuesto').value;
      if(!p || !i) { alert('Completa producto e impuesto para quitar'); return; }
      if(!confirm('¿Quitar impuesto del producto?')) return;
      try{ 
        const u = new URL(API.prodImp, location.origin); 
        u.searchParams.set('id_producto', p); 
        u.searchParams.set('id_impuesto', i); 
        await fetch(u, { method:'DELETE', headers: authHeaders() }).then(r=>r.json()); 
        await verAsignaciones(); 
      }
      catch(err){ alert('Error quitando: '+err.message); }
    });

    async function verAsignaciones(){
      const p = document.getElementById('pi_ver_producto').value || document.getElementById('pi_id_producto').value;
      if(!p) { document.getElementById('pi_tbody').innerHTML=''; return; }
      try{ const u = new URL(API.prodImp, location.origin); u.searchParams.set('id_producto', p); const data = await apiGet(u);
        document.getElementById('pi_tbody').innerHTML = (data.impuestos||[]).map(x=>`<tr>
          <td>${escapeHTML(x.id_impuesto)}</td>
          <td class="code">${escapeHTML(x.codigo||'')}</td>
          <td>${escapeHTML(x.nombre||'')}</td>
          <td>${escapeHTML(x.tipo||'')}</td>
          <td>${escapeHTML(x.valor||'')}</td>
        </tr>`).join('');
      }catch(err){ alert('Error consultando asignaciones: '+err.message); }
    }
    document.getElementById('btnVerPI').addEventListener('click', verAsignaciones);

    // Buscar productos
    document.getElementById('btnBuscarProd').addEventListener('click', async ()=>{
      const q = document.getElementById('pi_buscar').value.trim();
      if(!q) { alert('Ingresa un término'); return; }
      try{
        const u = new URL(API.producto, location.origin); u.searchParams.set('buscar', q);
        const data = await apiGet(u);
        const rows = data.productos||[];
        const wrap = document.getElementById('pi_results_wrap');
        const tb = document.getElementById('pi_results');
        wrap.style.display = rows.length ? '' : 'none';
        tb.innerHTML = rows.map(p=>`<tr>
          <td>${escapeHTML(p.id_producto)}</td>
          <td>${escapeHTML(p.nombre)}</td>
          <td>${escapeHTML(p.precio)}</td>
          <td class="text-end"><button class="btn btn-sm btn-outline-primary" data-pick-prod="${escapeHTML(p.id_producto)}" data-pick-nombre="${escapeHTML(p.nombre)}">Elegir</button></td>
        </tr>`).join('');
      }catch(err){ alert('Error buscando productos: '+err.message); }
    });

    document.addEventListener('click', (e)=>{
      const btnPick = e.target.closest('[data-pick-prod]');
      if(btnPick){
        const id = btnPick.getAttribute('data-pick-prod');
        const nombre = btnPick.getAttribute('data-pick-nombre');
        document.getElementById('pi_id_producto').value = id;
        document.getElementById('pi_nombre_producto').value = nombre;
        document.getElementById('pi_ver_producto').value = id;
        // Actualizar input readonly de visualización
        document.getElementById('pi_producto_empty').value = `ID: ${id} - ${nombre}`;
      }
    });
  </script>

  <!-- Scripts: Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Layout scripts -->
  <script src="../../Shared/Assets/js/layout.js"></script>
  <script>
      fetch('../../Shared/Views/sidebar.html')
          .then(r => r.text())
          .then(html => {
              document.getElementById('layoutContainer').innerHTML = html;
              initLayout();
          });
  </script>
</body>
</html>
