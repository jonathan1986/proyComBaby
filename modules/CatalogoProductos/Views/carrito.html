<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carrito de compras</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    .img-thumb { width: 64px; height: 64px; object-fit: cover; border-radius: 4px; }
    .cart-summary .value { font-weight: 700; }
  </style>
</head>
<body>
  <div class="container my-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap mb-3 gap-2">
      <div class="d-flex align-items-center gap-3">
        <a href="catalogo_productos.html" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Seguir comprando</a>
        <h1 class="h4 m-0">Carrito de compras</h1>
      </div>
      <div class="d-flex gap-2">
        <button id="btnVaciar" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash"></i> Vaciar</button>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <div class="table-responsive">
          <table class="table align-middle" id="tablaCarrito">
            <thead>
              <tr>
                <th>Producto</th>
                <th class="text-center" style="width:120px">Cant.</th>
                <th class="text-end" style="width:140px">Precio</th>
                <th class="text-end" style="width:160px">Subtotal</th>
                <th class="text-end" style="width:80px">Quitar</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card cart-summary">
          <div class="card-body">
            <h2 class="h6">Resumen</h2>
            <div class="d-flex justify-content-between">
              <span>Moneda</span>
              <span class="value" id="monedaText">USD</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Subtotal</span>
              <span class="value" id="subtotalText">0.00</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Descuento</span>
              <span class="value" id="descuentoText">0.00</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Impuesto</span>
              <span class="value" id="impuestoText">0.00</span>
            </div>
            <div id="taxBreakdown" class="mt-2" style="display:none;">
              <div class="text-muted small mb-1">Desglose impuestos</div>
              <div id="taxList" class="small"></div>
            </div>
            <hr />
            <div class="d-flex justify-content-between fs-5">
              <span>Total</span>
              <span class="value" id="totalText">0.00</span>
            </div>
            <hr />
            <form id="formCabecera" class="row g-2">
              <div class="col-12">
                <label class="form-label small">Modo impuestos</label>
                <select id="impuestos_modo" class="form-select form-select-sm">
                  <option value="simple">Simple</option>
                  <option value="multi">Multi</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label small">Impuesto (%)</label>
                <input type="number" step="0.01" min="0" max="100" class="form-control form-control-sm" id="impuesto_pct" />
              </div>
              <div class="col-6">
                <label class="form-label small">Desc. (%)</label>
                <input type="number" step="0.01" min="0" max="100" class="form-control form-control-sm" id="descuento_pct" />
              </div>
              <div class="col-12">
                <label class="form-label small">Desc. fijo</label>
                <input type="number" step="0.01" min="0" class="form-control form-control-sm" id="descuento_monto" />
              </div>
              <div class="col-12 d-grid mt-1">
                <button class="btn btn-primary btn-sm" type="submit">Actualizar totales</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function escapeHTML(s){return (s??'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

    // Descubre base del módulo
    (function initBase(){
      const p = location.pathname.replace(/\\/g,'/');
      const marker = '/modules/CatalogoProductos/Views/';
      const idx = p.indexOf(marker);
      window.CATALOGO_BASE = idx!==-1 ? p.substring(0, idx+1)+'modules/CatalogoProductos/' : '/modules/CatalogoProductos/';
    })();

    const ENDPOINTS = {
      carrito: window.CATALOGO_BASE + 'Controllers/carrito_api.php',
      items: window.CATALOGO_BASE + 'Controllers/carrito_items_api.php'
    };

    // Estado del carrito
    const cart = { id:null, moneda:'USD', usuario:null, token:null };

    // Simple session token para anónimo si no hay uno
    function ensureToken(){
      let t = localStorage.getItem('session_token');
      if(!t){ t = [...crypto.getRandomValues(new Uint8Array(16))].map(b=>('0'+b.toString(16)).slice(-2)).join(''); }
      localStorage.setItem('session_token', t);
      return t;
    }

    async function fetchJSON(url, opts){
      const resp = await fetch(url, opts);
      const data = await resp.json().catch(()=>({}));
      if(!resp.ok || data.success===false){ throw new Error(data.error || 'Error HTTP '+resp.status); }
      return data;
    }

    async function cargarCarrito(){
      // 1) Buscar carrito abierto por usuario/token
      cart.token = ensureToken();
      try{
        const data = await fetchJSON(`${ENDPOINTS.carrito}?session_token=${encodeURIComponent(cart.token)}`);
        cart.id = data.carrito?.id_carrito; cart.moneda = data.carrito?.moneda || 'USD'; cart.modo = data.carrito?.impuestos_modo || 'simple';
      }catch{
        // 2) Crear si no existe
        const body = { session_token: cart.token, moneda: 'USD' };
        const data = await fetchJSON(ENDPOINTS.carrito, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        cart.id = data.carrito?.id_carrito; cart.moneda = data.carrito?.moneda || 'USD'; cart.modo = data.carrito?.impuestos_modo || 'simple';
      }
      document.getElementById('monedaText').textContent = escapeHTML(cart.moneda);
      await cargarItems();
      await refrescarCabecera();
    }

    async function cargarItems(){
      const data = await fetchJSON(`${ENDPOINTS.items}?id_carrito=${encodeURIComponent(cart.id)}`);
      const items = Array.isArray(data.items)?data.items:[];
      renderItems(items);
      broadcastChange();
    }

    function renderItems(items){
      const tbody = document.querySelector('#tablaCarrito tbody');
      if(!tbody) return;
  if(!items.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-muted">Tu carrito está vacío</td></tr>'; return; }
      // Resolver URL de imagen para evitar rutas relativas a Views/
      const resolveImg = (p) => {
        if (!p) return '';
        const s = String(p);
        if (/^https?:\/\//i.test(s)) return s; // absoluta
        if (s.startsWith('/')) return s;         // absoluta desde raíz
        if (s.startsWith('uploads/')) return '/' + s; // normaliza a raíz
        return s; // fallback
      };
      tbody.innerHTML = items.map(it=>{
        const imgSrc = resolveImg(it.imagen_principal);
        const img = imgSrc ? `<img src="${escapeHTML(imgSrc)}" class="img-thumb me-2" alt="img">` : '';
        const precio = Number(it.precio_unit||0).toFixed(2);
        const sub = Number(it.subtotal_linea||0).toFixed(2);
        // Desglose de impuestos por ítem (modo multi)
        let impHtml = '';
        if (Array.isArray(it.impuestos) && it.impuestos.length) {
          const lines = it.impuestos.map(x=>{
            const label = escapeHTML(`${x.codigo||'IMP'}: ${x.nombre||''}`);
            const monto = Number(x.monto||0).toFixed(2);
            return `<div class="d-flex justify-content-between"><span>${label}</span><span>${monto}</span></div>`;
          }).join('');
          const totalItemImp = Number(it.impuestos_total||0).toFixed(2);
          const base = (it.base_con_descuento!==null && it.base_con_descuento!==undefined) ? `Base: ${Number(it.base_con_descuento).toFixed(2)}` : '';
          impHtml = `<div class="mt-1 small text-muted">
              <div>Impuestos (ítem): <span class="fw-semibold">${totalItemImp}</span></div>
              ${base?`<div>${escapeHTML(base)}</div>`:''}
              <div class="border rounded p-2 mt-1">${lines}</div>
            </div>`;
        }
        return `<tr data-producto="${escapeHTML(it.id_producto)}">
          <td>
            <div class="d-flex align-items-center">${img}<div>
              <div class="fw-semibold">${escapeHTML(it.producto||'')}</div>
              <div class="text-muted small">ID: ${escapeHTML(it.id_producto)}</div>
              ${impHtml}
            </div></div>
          </td>
          <td class="text-center">
            <input type="number" class="form-control form-control-sm qty" min="1" max="999" value="${escapeHTML(it.cantidad)}" style="width:90px; margin:0 auto;">
          </td>
          <td class="text-end">${precio}</td>
          <td class="text-end subtotal">${sub}</td>
          <td class="text-end"><button class="btn btn-outline-danger btn-sm btn-remove" title="Quitar"><i class="bi bi-x"></i></button></td>
        </tr>`;
      }).join('');
    }

    async function refrescarCabecera(){
      const d = await fetchJSON(`${ENDPOINTS.carrito}?id=${encodeURIComponent(cart.id)}`);
      const c = d.carrito || {};
      document.getElementById('subtotalText').textContent = Number(c.subtotal||0).toFixed(2);
      document.getElementById('descuentoText').textContent = Number(c.descuento_total||0).toFixed(2);
      document.getElementById('impuestoText').textContent = Number(c.impuesto_total||0).toFixed(2);
      document.getElementById('totalText').textContent = Number(c.total||0).toFixed(2);
      document.getElementById('impuesto_pct').value = c.impuesto_pct ?? '';
      document.getElementById('descuento_pct').value = c.descuento_pct ?? '';
      document.getElementById('descuento_monto').value = c.descuento_monto ?? '';
      cart.modo = c.impuestos_modo || cart.modo;
      const selModo = document.getElementById('impuestos_modo');
      if (selModo) selModo.value = cart.modo;
      const impuestoPctField = document.getElementById('impuesto_pct');
      if (impuestoPctField) {
        const wrap = impuestoPctField.closest('.col-6');
        if (wrap) wrap.style.display = (cart.modo === 'multi') ? 'none' : '';
      }

      // Mostrar desglose si viene desde API (modo multi)
      const tb = document.getElementById('taxBreakdown');
      const tl = document.getElementById('taxList');
      if (Array.isArray(c.impuestos_desglose) && c.impuestos_desglose.length) {
        tb.style.display = '';
        tl.innerHTML = c.impuestos_desglose.map(x=>{
          const label = escapeHTML((x.codigo||'IMP')+': '+(x.nombre||''));
          const monto = Number(x.monto||0).toFixed(2);
          return `<div class="d-flex justify-content-between"><span>${label}</span><span>${monto}</span></div>`;
        }).join('');
      } else {
        tb.style.display = 'none'; tl.innerHTML = '';
      }
    }

    // Delegación de eventos: cambiar cantidad y eliminar
    document.addEventListener('input', async (e)=>{
      const input = e.target.closest('input.qty');
      if(!input) return;
      const tr = input.closest('tr');
      const idProd = tr?.getAttribute('data-producto');
      const qty = Math.min(999, Math.max(1, parseInt(input.value||'1',10)));
      input.value = String(qty);
      try{
        const body = { id_producto: Number(idProd), cantidad: qty };
        await fetchJSON(`${ENDPOINTS.items}?id_carrito=${encodeURIComponent(cart.id)}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        await cargarItems();
        await refrescarCabecera();
        broadcastChange();
      }catch(err){ alert('No se pudo actualizar la cantidad: '+err.message); }
    });

    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.btn-remove');
      if(!btn) return;
      const tr = btn.closest('tr');
      const idProd = tr?.getAttribute('data-producto');
      try{
        await fetchJSON(`${ENDPOINTS.items}?id_carrito=${encodeURIComponent(cart.id)}&id_producto=${encodeURIComponent(idProd)}`, { method:'DELETE' });
        await cargarItems();
        await refrescarCabecera();
        broadcastChange();
      }catch(err){ alert('No se pudo eliminar el ítem: '+err.message); }
    });

    // Vaciar carrito: elimina uno por uno (simple)
    document.getElementById('btnVaciar').addEventListener('click', async ()=>{
      if(!confirm('¿Vaciar carrito?')) return;
      try{
        await fetchJSON(`${ENDPOINTS.items}?id_carrito=${encodeURIComponent(cart.id)}&empty=1`, { method:'DELETE' });
        // Después de vaciar, refrescamos directamente la UI a estado vacío
        renderItems([]);
        await refrescarCabecera();
        broadcastChange();
      }catch(err){ alert('No se pudo vaciar el carrito: '+err.message); }
    });

    // Actualizar cabecera (impuestos/descuentos)
    document.getElementById('formCabecera').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const imp = document.getElementById('impuesto_pct').value || 0;
      const dp = document.getElementById('descuento_pct').value || 0;
      const dm = document.getElementById('descuento_monto').value || 0;
      const modo = document.getElementById('impuestos_modo')?.value || cart.modo || 'simple';
      try{
        const body = { impuestos_modo: modo, impuesto_pct: Number(imp), descuento_pct: Number(dp), descuento_monto: Number(dm) };
        await fetchJSON(`${ENDPOINTS.carrito}?id=${encodeURIComponent(cart.id)}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        await refrescarCabecera();
        broadcastChange();
      }catch(err){ alert('No se pudo actualizar la cabecera: '+err.message); }
    });

    // Broadcasting cross-tab (BroadcastChannel con fallback localStorage)
    let bc;
    try { bc = new BroadcastChannel('cart_changes'); } catch {}
    function broadcastChange(){
      const payload = { t: Date.now(), cartId: cart.id };
      if (bc) {
        bc.postMessage(payload);
      } else {
        try { localStorage.setItem('cart_change_ping', JSON.stringify(payload)); } catch {}
      }
    }
    // Start
    cargarCarrito().catch(err=>{ alert('Error iniciando carrito: '+err.message); });
  </script>
</body>
</html>
