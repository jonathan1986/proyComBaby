<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n de Proveedores</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="catalogo.css">
</head>
<body>
    <div class="rounded shadow-sm d-flex align-items-center justify-content-between px-4 py-3 mb-4" style="background-color: rgb(232,232,232); color: #333;">
        <h1 class="mb-0" style="font-size:1.7rem;">Gesti√≥n de Proveedores</h1>
        <button id="btnMostrarForm" type="button" class="btn btn-success fw-bold">
            <span class="me-2">‚ûï</span> A√±adir
        </button>
    </div>
    <form id="proveedorForm" class="card p-4 mb-4 shadow-sm" style="display:none; max-width: 500px;">
        <div style="background:#d7d8e5; border-radius:6px; padding:10px; margin-bottom:18px;">
            <h4 id="formTitulo" class="mb-0 fw-bold text-center"></h4>
        </div>
        <div class="mb-3">
            <label for="nombre" class="form-label mb-1"><strong>Nombre del proveedor</strong></label>
            <input type="text" id="nombre" name="nombre" maxlength="100" required class="form-control">
            <span id="nombreError" class="text-danger small"></span>
        </div>
        <div class="mb-3">
            <label for="contacto" class="form-label mb-1"><strong>Persona de contacto</strong></label>
            <input type="text" id="contacto" name="contacto" maxlength="100" class="form-control">
        </div>
        <div class="mb-3">
            <label for="telefono" class="form-label mb-1"><strong>Tel√©fono</strong></label>
            <input type="text" id="telefono" name="telefono" maxlength="30" class="form-control">
        </div>
        <div class="mb-3">
            <label for="email" class="form-label mb-1"><strong>Email</strong></label>
            <input type="email" id="email" name="email" maxlength="100" class="form-control">
        </div>
        <div class="mb-3">
            <label for="direccion" class="form-label mb-1"><strong>Direcci√≥n</strong></label>
            <input type="text" id="direccion" name="direccion" maxlength="255" class="form-control">
        </div>
        <div class="mb-3">
            <label for="ciudad" class="form-label mb-1"><strong>Ciudad</strong></label>
            <input type="text" id="ciudad" name="ciudad" maxlength="100" class="form-control">
        </div>
        <div class="mb-3">
            <label for="ruc" class="form-label mb-1"><strong>RUC</strong></label>
            <input type="text" id="ruc" name="ruc" maxlength="20" class="form-control">
        </div>
        <div class="mb-3">
            <label for="estado" class="form-label mb-1"><strong>Estado</strong></label>
            <select id="estado" name="estado" required class="form-select">
                <option value="1" selected>Activo</option>
                <option value="0">Inactivo</option>
            </select>
        </div>
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-fill">Guardar</button>
            <button type="button" id="btnCancelarForm" class="btn btn-secondary flex-fill">Cancelar</button>
        </div>
    </form>
    <div class="container mt-4">
        <div class="row mb-3 align-items-end">
            <div class="col-12">
                <div style="background:#f4f4fa; border-radius:8px; border:1px solid #d7d8e5; padding:18px;" class="mb-2">
                    <div class="d-flex align-items-center flex-nowrap gap-3 w-100 mb-2">
                        <label for="filtroCampo" class="form-label mb-0" style="white-space:nowrap;">Filtro campo:</label>
                        <select id="filtroCampo" class="form-select flex-grow-1" style="min-width:180px;max-width:300px;">
                            <option value="nombre">Nombre</option>
                            <option value="contacto">Contacto</option>
                            <option value="ciudad">Ciudad</option>
                            <option value="id_proveedor">ID</option>
                        </select>
                        <div class="d-flex ms-auto align-items-center" style="min-width:220px;">
                            <label for="ordenCampo" class="form-label mb-0 me-2" style="white-space:nowrap;">Orden:</label>
                            <select id="ordenCampo" class="form-select" style="min-width:120px;max-width:180px;">
                                <option value="asc">Ascendente</option>
                                <option value="desc">Descendente</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-flex align-items-center flex-nowrap gap-2 w-100 mt-2">
                        <label for="busqueda" class="form-label mb-0" style="white-space:nowrap;">Buscar:</label>
                        <input type="text" id="busqueda" class="form-control flex-grow-1" placeholder="Buscar..." style="min-width:180px;max-width:300px;">
                    </div>
                </div>
            </div>
        </div>
        <table id="tablaProveedores" class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>#</th>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Contacto</th>
                    <th>Tel√©fono</th>
                    <th>Email</th>
                    <th>Ciudad</th>
                    <th>RUC</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <script>
    let proveedores = [];
    function renderProveedores() {
        const campo = document.getElementById('filtroCampo').value;
        const busqueda = document.getElementById('busqueda').value.toLowerCase();
        const orden = document.getElementById('ordenCampo').value;
        let filtrados = proveedores.filter(prov => {
            if (!busqueda) return true;
            let valor = (prov[campo] || '').toString().toLowerCase();
            return valor.includes(busqueda);
        });
        filtrados.sort((a, b) => {
            let va = (a[campo] || '').toString().toLowerCase();
            let vb = (b[campo] || '').toString().toLowerCase();
            if (campo === 'id_proveedor') {
                va = parseInt(a[campo]);
                vb = parseInt(b[campo]);
                if (isNaN(va)) va = 0;
                if (isNaN(vb)) vb = 0;
            }
            if (va < vb) return orden === 'asc' ? -1 : 1;
            if (va > vb) return orden === 'asc' ? 1 : -1;
            return 0;
        });
        const tbody = document.querySelector('#tablaProveedores tbody');
        tbody.innerHTML = '';
        function escapeHtml(text) {
            return text.replace(/[&<>'"`=]/g, function (c) {
                return {'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;','`':'&#96;','=':'&#61;'}[c];
            });
        }
        filtrados.forEach((prov, i) => {
            tbody.innerHTML += `<tr>
                <td>${i+1}</td>
                <td>${escapeHtml(prov.id_proveedor.toString())}</td>
                <td>${escapeHtml(prov.nombre)}</td>
                <td>${escapeHtml(prov.contacto)}</td>
                <td>${escapeHtml(prov.telefono)}</td>
                <td>${escapeHtml(prov.email)}</td>
                <td>${escapeHtml(prov.ciudad)}</td>
                <td>${escapeHtml(prov.ruc)}</td>
                <td>${prov.estado == 1 ? 'Activo' : 'Inactivo'}</td>
                <td>
                    <button title='Ver' onclick='verProveedor(${escapeHtml(prov.id_proveedor.toString())})'>üîç</button>
                    <button title='Editar' onclick='editarProveedor(${escapeHtml(prov.id_proveedor.toString())})'>‚úèÔ∏è</button>
                    <button title='Eliminar' onclick='eliminarProveedor(${escapeHtml(prov.id_proveedor.toString())})'>‚ùå</button>
                </td>
            </tr>`;
        });
        $('#tablaProveedores').DataTable({
            destroy: true,
            searching: false,
            paging: true,
            info: false,
            pageLength: 10,
            lengthChange: false
        });
    }
    function cargarProveedores() {
        fetch('../Controllers/proveedor_api.php')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    proveedores = data.proveedores;
                    renderProveedores();
                }
            });
    }
    document.getElementById('filtroCampo').addEventListener('change', renderProveedores);
    document.getElementById('ordenCampo').addEventListener('change', renderProveedores);
    document.getElementById('busqueda').addEventListener('input', renderProveedores);

    // CRUD funcional
    const btnMostrarForm = document.getElementById('btnMostrarForm');
    const proveedorForm = document.getElementById('proveedorForm');
    const btnCancelarForm = document.getElementById('btnCancelarForm');

    btnMostrarForm.addEventListener('click', function() {
        proveedorForm.style.display = 'flex';
        document.getElementById('formTitulo').textContent = 'A√±adir proveedor';
        btnMostrarForm.disabled = true;
        document.getElementById('filtroCampo').disabled = true;
        document.getElementById('ordenCampo').disabled = true;
        document.getElementById('busqueda').disabled = true;
        document.getElementById('tablaProveedores').classList.add('table-disabled');
    });

    btnCancelarForm.addEventListener('click', function() {
        proveedorForm.style.display = 'none';
        btnMostrarForm.disabled = false;
        document.getElementById('filtroCampo').disabled = false;
        document.getElementById('ordenCampo').disabled = false;
        document.getElementById('busqueda').disabled = false;
        document.getElementById('tablaProveedores').classList.remove('table-disabled');
        document.getElementById('nombre').disabled = false;
        proveedorForm.querySelector('button[type="submit"]').disabled = false;
    });

    let modoEdicion = false;
    let idEdicion = null;
    proveedorForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const form = this;
        const nombre = form.nombre.value.trim();
        const regex = /^[\w\s√°√©√≠√≥√∫√Å√â√ç√ì√ö√º√ú√±√ë.,-]{1,100}$/;
        if (!regex.test(nombre)) {
            alert('Nombre inv√°lido. Solo letras, n√∫meros y algunos signos permitidos. M√°x 100 caracteres.');
            form.nombre.focus();
            return;
        }
        const datos = new FormData(form);
        let url = '../Controllers/proveedor_api.php';
        let fetchConfig = { method: 'POST', body: datos };
        if (modoEdicion && idEdicion) {
            datos.append('id', idEdicion);
            url += '?id=' + idEdicion;
            fetchConfig = { method: 'PUT', body: new URLSearchParams(datos) };
        }
        fetch(url, fetchConfig)
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    alert(modoEdicion ? 'Proveedor actualizado' : 'Proveedor guardado con ID: ' + data.id);
                    form.reset();
                    proveedorForm.style.display = 'none';
                    btnMostrarForm.disabled = false;
                    document.getElementById('filtroCampo').disabled = false;
                    document.getElementById('ordenCampo').disabled = false;
                    document.getElementById('busqueda').disabled = false;
                    document.getElementById('tablaProveedores').classList.remove('table-disabled');
                    cargarProveedores();
                    modoEdicion = false;
                    idEdicion = null;
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(function(err) { alert('Error de conexi√≥n: ' + err.message); });
    });

    document.getElementById('nombre').addEventListener('input', function() {
        const nombre = this.value;
        const regex = /^[\w\s√°√©√≠√≥√∫√Å√â√ç√ì√ö√º√ú√±√ë.,-]{1,100}$/;
        const errorSpan = document.getElementById('nombreError');
        if (!regex.test(nombre)) {
            errorSpan.textContent = 'Solo letras, n√∫meros y algunos signos permitidos. M√°x 100 caracteres.';
            this.classList.add('is-invalid');
        } else {
            errorSpan.textContent = '';
            this.classList.remove('is-invalid');
        }
    });

    window.verProveedor = function(id) {
        const prov = proveedores.find(p => p.id_proveedor === id);
        if (prov) {
            proveedorForm.style.display = 'flex';
            document.getElementById('formTitulo').textContent = 'Consultar proveedor';
            btnMostrarForm.disabled = true;
            document.getElementById('filtroCampo').disabled = true;
            document.getElementById('ordenCampo').disabled = true;
            document.getElementById('busqueda').disabled = true;
            document.getElementById('tablaProveedores').classList.add('table-disabled');
            document.getElementById('nombre').value = prov.nombre;
            document.getElementById('contacto').value = prov.contacto;
            document.getElementById('telefono').value = prov.telefono;
            document.getElementById('email').value = prov.email;
            document.getElementById('direccion').value = prov.direccion;
            document.getElementById('ciudad').value = prov.ciudad;
            document.getElementById('ruc').value = prov.ruc;
            document.getElementById('estado').value = prov.estado;
            document.getElementById('nombre').disabled = true;
            document.getElementById('contacto').disabled = true;
            document.getElementById('telefono').disabled = true;
            document.getElementById('email').disabled = true;
            document.getElementById('direccion').disabled = true;
            document.getElementById('ciudad').disabled = true;
            document.getElementById('ruc').disabled = true;
            document.getElementById('estado').disabled = true;
            proveedorForm.querySelector('button[type="submit"]').disabled = true;
            btnCancelarForm.disabled = false;
        }
    }
    window.editarProveedor = function(id) {
        const prov = proveedores.find(p => p.id_proveedor === id);
        if (prov) {
            modoEdicion = true;
            idEdicion = id;
            proveedorForm.style.display = 'flex';
            document.getElementById('formTitulo').textContent = 'Editar proveedor';
            btnMostrarForm.disabled = true;
            document.getElementById('filtroCampo').disabled = true;
            document.getElementById('ordenCampo').disabled = true;
            document.getElementById('busqueda').disabled = true;
            document.getElementById('tablaProveedores').classList.add('table-disabled');
            document.getElementById('nombre').value = prov.nombre;
            document.getElementById('contacto').value = prov.contacto;
            document.getElementById('telefono').value = prov.telefono;
            document.getElementById('email').value = prov.email;
            document.getElementById('direccion').value = prov.direccion;
            document.getElementById('ciudad').value = prov.ciudad;
            document.getElementById('ruc').value = prov.ruc;
            document.getElementById('estado').value = prov.estado;
                // Habilitar campos para edici√≥n
                document.getElementById('contacto').disabled = false;
                document.getElementById('telefono').disabled = false;
                document.getElementById('email').disabled = false;
                document.getElementById('direccion').disabled = false;
                document.getElementById('ciudad').disabled = false;
                document.getElementById('ruc').disabled = false;
                document.getElementById('estado').disabled = false;
        }
    }
    window.eliminarProveedor = function(id) {
        if (confirm('¬øEliminar proveedor?')) {
            fetch('../Controllers/proveedor_api.php?id=' + id, {
                method: 'DELETE'
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Proveedor eliminado');
                    cargarProveedores();
                } else {
                    alert('Error: ' + data.error);
                }
            });
        }
    }
    cargarProveedores();
    </script>
</body>
</html>
<style>
.table-disabled {
    pointer-events: none;
    opacity: 0.5;
}
</style>
