<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Producto - Gestión</title>
	<link rel="icon" href="data:,">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link href="https://cdn.datatables.net/v/bs5/dt-2.0.7/datatables.min.css" rel="stylesheet"/>
	<link rel="stylesheet" href="../../Shared/Assets/css/layout.css">
	<style>
		.tab-pane { padding-top: 1rem; }
		.is-invalid + .invalid-feedback { display: block; }
		.required::after { content: " *"; color: #dc3545; }
	</style>
</head>
<body>
	<!-- Incluir sidebar y topbar -->
	<div id="layoutContainer"></div>

	<!-- Mensaje de acceso restringido -->
	<div id="accessDenied" class="container mt-5" style="display: none; margin-left: 260px;">
		<div class="alert alert-danger text-center">
			<h4>⚠️ Acceso Restringido</h4>
			<p>No tienes permisos para acceder a esta página.</p>
			<p>Roles requeridos: <strong>ADMINISTRADOR</strong> o <strong>GESTOR_CONTENIDOS</strong></p>
		</div>
	</div>

	<div id="mainContent" style="display: none;">
		<div class="d-flex align-items-center justify-content-between mb-3">
			<h1 class="h3 m-0">Producto - Gestión</h1>
			<div class="d-flex align-items-center gap-2">
				<button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalBuscarProducto">Buscar producto</button>
				<button type="button" class="btn btn-success btn-sm d-flex align-items-center gap-1" id="btnNuevoProducto" title="Añadir nuevo producto">
					<span class="bi bi-plus-lg" aria-hidden="true"></span> Añadir
				</button>
				<span id="productoIdBadge" class="badge text-bg-secondary d-none">ID: <span id="productoIdText"></span></span>
			</div>
		</div>

		<ul class="nav nav-tabs" id="productoTabs" role="tablist">
			<li class="nav-item" role="presentation">
				<button class="nav-link active" id="tab-datos" data-bs-toggle="tab" data-bs-target="#pane-datos" type="button" role="tab">Datos</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link disabled" id="tab-categorias" data-bs-toggle="tab" data-bs-target="#pane-categorias" type="button" role="tab" aria-disabled="true">Categorías</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link disabled" id="tab-atributos" data-bs-toggle="tab" data-bs-target="#pane-atributos" type="button" role="tab" aria-disabled="true">Atributos</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link disabled" id="tab-impuestos" data-bs-toggle="tab" data-bs-target="#pane-impuestos" type="button" role="tab" aria-disabled="true">Impuestos</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link disabled" id="tab-proveedores" data-bs-toggle="tab" data-bs-target="#pane-proveedores" type="button" role="tab" aria-disabled="true">Proveedores</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link disabled" id="tab-imagenes" data-bs-toggle="tab" data-bs-target="#pane-imagenes" type="button" role="tab" aria-disabled="true">Imágenes</button>
			</li>
		</ul>

		<div class="tab-content" id="productoTabsContent">
			<!-- TAB: DATOS -->
			<div class="tab-pane fade show active" id="pane-datos" role="tabpanel" aria-labelledby="tab-datos">
				<form id="productoForm" novalidate class="mt-3">
					<div class="row g-3">
						<div class="col-md-6">
							<label class="form-label required" for="nombre">Nombre</label>
							<input type="text" id="nombre" name="nombre" class="form-control" maxlength="100" required placeholder="Nombre del producto" />
							<div class="invalid-feedback" id="nombreError">El nombre es obligatorio, máximo 100 caracteres; solo letras, números, espacios y . , - _ & permitidos.</div>
						</div>
						<div class="col-md-6">
							<label class="form-label required" for="precio">Precio</label>
							<input type="number" step="0.01" min="0" id="precio" name="precio" class="form-control" required placeholder="0.00" />
							<div class="invalid-feedback">Ingresa un precio válido (>= 0).</div>
						</div>
						<div class="col-12">
							<label class="form-label" for="descripcion">Descripción</label>
							<textarea id="descripcion" name="descripcion" class="form-control" rows="3" placeholder="Descripción del producto"></textarea>
						</div>
						<div class="col-md-4">
							<label class="form-label required" for="stock">Stock</label>
							<input type="number" min="0" id="stock" name="stock" class="form-control" required placeholder="0" />
							<div class="invalid-feedback">Ingresa un stock válido (>= 0).</div>
						</div>
						<div class="col-md-4">
							<label class="form-label" for="stock_minimo">Stock mínimo</label>
							<input type="number" min="0" id="stock_minimo" name="stock_minimo" class="form-control" placeholder="0" />
						</div>
						<div class="col-md-4">
							<label class="form-label required" for="estado">Estado</label>
							<select id="estado" name="estado" class="form-select" required>
								<option value="activo" selected>Activo</option>
								<option value="inactivo">Inactivo</option>
							</select>
							<div class="invalid-feedback">Selecciona un estado.</div>
						</div>
					</div>
					<div class="mt-4 d-flex gap-2">
						<button type="submit" class="btn btn-primary" id="btnGuardarProducto">Guardar producto</button>
						<button type="button" class="btn btn-outline-secondary" id="btnLimpiar">Limpiar</button>
					</div>
				</form>
				<div class="alert alert-info mt-3" id="datosAyuda">Primero guarda los datos del producto para habilitar Categorías, Atributos, Proveedores e Imágenes.</div>

				<!-- Panel rápido de Inventario para este producto -->
				<div id="panelInventario" class="mt-4 d-none">
					<div class="d-flex justify-content-between align-items-center mb-2">
						<h2 class="h6 m-0">Inventario del producto</h2>
						<button type="button" class="btn btn-sm btn-outline-primary" id="btnVerInventario">Ver en Inventario → Movimientos</button>
					</div>
					<div class="row g-3">
						<div class="col-md-4">
							<div class="card">
								<div class="card-body">
									<div class="text-muted small">Stock disponible</div>
									<div id="stockDisponibleText" class="display-6">-</div>
								</div>
							</div>
						</div>
						<div class="col-md-8">
							<div class="card">
								<div class="card-body">
									<div class="d-flex justify-content-between align-items-center mb-2">
										<div class="text-muted small">Últimos movimientos</div>
									</div>
									<div class="table-responsive">
										<table class="table table-sm" id="tablaUltimosMovimientos">
											<thead><tr><th>Fecha</th><th>Tipo</th><th>Cant.</th><th>Motivo</th></tr></thead>
											<tbody><tr><td colspan="4" class="text-muted">Sin datos</td></tr></tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- TAB: CATEGORÍAS -->
			<div class="tab-pane fade" id="pane-categorias" role="tabpanel" aria-labelledby="tab-categorias">
				<div class="d-flex justify-content-between align-items-center mt-3">
					<h2 class="h5 m-0">Asignar categorías</h2>
					<button class="btn btn-sm btn-outline-primary" id="btnRefrescarCategorias">Refrescar</button>
				</div>
				<div class="mt-3" id="categoriasContainer">
					<div class="text-muted">Cargando categorías…</div>
				</div>
				<div class="mt-3">
					<button class="btn btn-success" id="btnGuardarCategorias">Guardar categorías</button>
					<small class="text-muted d-block mt-1">Nota: Requiere un endpoint para N:M (productos_categorias_api.php).</small>
				</div>
			</div>

			<!-- TAB: ATRIBUTOS -->
			<div class="tab-pane fade" id="pane-atributos" role="tabpanel" aria-labelledby="tab-atributos">
				<div class="d-flex justify-content-between align-items-center mt-3">
					<h2 class="h5 m-0">Atributos del producto</h2>
					<button class="btn btn-sm btn-outline-primary" id="btnRefrescarAtributos">Refrescar</button>
				</div>
				<div class="table-responsive mt-3">
					<table class="table align-middle" id="tablaAtributos">
						<thead>
							<tr>
								<th>Atributo</th>
								<th>Tipo</th>
								<th>Valor</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>
				<div class="mt-3">
					<button class="btn btn-success" id="btnGuardarAtributos">Guardar atributos</button>
					<small class="text-muted d-block mt-1">Nota: Requiere un endpoint para N:M (productos_atributos_api.php).</small>
				</div>
			</div>

			<!-- TAB: IMPUESTOS -->
			<div class="tab-pane fade" id="pane-impuestos" role="tabpanel" aria-labelledby="tab-impuestos">
				<div class="d-flex justify-content-between align-items-center mt-3">
					<h2 class="h5 m-0">Impuestos del producto</h2>
					<button class="btn btn-sm btn-outline-primary" id="btnRefrescarImpuestos">Refrescar</button>
				</div>
				<div class="row g-3 mt-1">
					<div class="col-md-8">
						<label for="pg_imp_sel" class="form-label">Seleccionar impuesto activo</label>
						<select id="pg_imp_sel" class="form-select">
							<option value="">-- Selecciona --</option>
						</select>
					</div>
					<div class="col-md-4 d-flex align-items-end">
						<button id="pg_imp_add" class="btn btn-success" disabled>Asignar</button>
					</div>
				</div>
				<div class="table-responsive mt-3">
					<table class="table table-striped align-middle" id="pg_imp_tbl">
						<thead>
							<tr>
								<th>Código</th>
								<th>Nombre</th>
								<th>Tipo</th>
								<th>Valor</th>
								<th>Aplica sobre</th>
								<th>Acciones</th>
							</tr>
						</thead>
						<tbody id="pg_imp_tbody"><tr><td colspan="6" class="text-muted">Sin datos</td></tr></tbody>
					</table>
				</div>
				<small class="text-muted d-block mt-2">Solo se listan impuestos activos.</small>
			</div>

			<!-- TAB: PROVEEDORES -->
			<div class="tab-pane fade" id="pane-proveedores" role="tabpanel" aria-labelledby="tab-proveedores">
				<div class="row mt-3 g-3">
					<div class="col-12">
						<h2 class="h5 m-0">Buscar y asignar proveedores</h2>
					</div>
					<div class="col-md-8">
						<div class="input-group">
							<input type="text" id="qProveedor" class="form-control" placeholder="Nombre del proveedor" maxlength="100" />
							<button class="btn btn-primary" id="btnBuscarProveedor">Buscar</button>
						</div>
						<small class="text-muted">Ingresa al menos 1 carácter (máx. 100). Se muestran hasta 200 resultados.</small>
					</div>
					<div class="col-12">
						<div class="table-responsive">
							<table class="table table-hover" id="tablaResultadosProveedores">
								<thead><tr><th>ID</th><th>Nombre</th><th>Seleccionar</th></tr></thead>
								<tbody></tbody>
							</table>
						</div>
					</div>
					<div class="col-12">
						<h3 class="h6">Proveedores asignados</h3>
						<div id="listaProveedoresAsignados" class="d-flex flex-wrap gap-2"></div>
						<div class="mt-2">
							<button class="btn btn-success" id="btnGuardarProveedores">Guardar relación</button>
						</div>
					</div>
				</div>
				<small class="text-muted d-block mt-2">Nota: requiere endpoints de proveedor y relación producto–proveedor.</small>
			</div>

			<!-- TAB: IMÁGENES -->
			<div class="tab-pane fade" id="pane-imagenes" role="tabpanel" aria-labelledby="tab-imagenes">
				<form id="imagenForm" class="mt-3" enctype="multipart/form-data" action="javascript:void(0)">
					<div class="row g-3">
						<div class="col-md-6">
							<label for="archivo_imagen" class="form-label required">Archivo de imagen</label>
							<input class="form-control" type="file" id="archivo_imagen" name="archivo_imagen" accept="image/*" required />
							<div class="invalid-feedback">Selecciona una imagen (jpg, jpeg, png, gif, webp).</div>
						</div>
						<div class="col-md-3 d-flex align-items-end">
							<div class="form-check">
								<input class="form-check-input" type="checkbox" value="1" id="principal" name="principal" />
								<label class="form-check-label" for="principal">Principal</label>
							</div>
						</div>
						<div class="col-md-3 d-flex align-items-end">
							<button type="submit" class="btn btn-primary" id="btnSubirImagen">Subir imagen</button>
						</div>
					</div>
				</form>
				<hr />
				<div class="table-responsive">
					<table id="tablaImagenes" class="table table-striped w-100">
						<thead>
							<tr>
								<th>#</th>
								<th>Vista previa</th>
								<th>Archivo</th>
								<th>Principal</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal Buscar Producto -->
	<div class="modal fade" id="modalBuscarProducto" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-scrollable">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Buscar producto</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
				</div>
				<div class="modal-body">
					<div class="input-group mb-3">
						<input type="text" id="qProducto" class="form-control" placeholder="Nombre, ID..." />
						<button class="btn btn-primary" id="btnBuscarProducto">Buscar</button>
					</div>
					<div class="table-responsive">
						<table class="table table-hover" id="tablaResultadosProductos">
							<thead><tr><th>ID</th><th>Nombre</th><th>Acciones</th></tr></thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
				<div class="modal-footer">
					<small class="text-muted">Selecciona un producto para editar.</small>
				</div>
			</div>
		</div>
	</div>

	<!-- Scripts: Bootstrap + jQuery + DataTables + Lógica de la página -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
	<script src="https://cdn.datatables.net/v/bs5/dt-2.0.7/datatables.min.js"></script>

		<script>
		// ==================== AUTENTICACIÓN Y AUTORIZACIÓN ====================
		
		// La autenticación ahora se maneja en layout.js
		const ROLES_PERMITIDOS = ['ADMINISTRADOR', 'GESTOR_CONTENIDOS'];
		let authToken = localStorage.getItem('authToken');

		// ==================== UTILIDADES ====================
		
		// Utilidades de seguridad (OWASP): escapar HTML antes de inyectar
		function escapeHTML(str) {
			if (str === null || str === undefined) return '';
			return String(str)
				.replaceAll('&', '&amp;')
				.replaceAll('<', '&lt;')
				.replaceAll('>', '&gt;')
				.replaceAll('"', '&quot;')
				.replaceAll("'", '&#39;');
		}

		const state = {
			productoId: null,
			imagenes: []
		};

		// ================= RUTAS DINÁMICAS =================
		// Calcula la raíz del proyecto aunque la app esté alojada en un subdirectorio.
		// Ej: si la página actual es /miapp/modules/CatalogoProductos/Views/producto_gestion.html
		// basePath quedará en '/miapp/' y luego los endpoints serán '/miapp/modules/CatalogoProductos/Controllers/...'
		(function initBasePaths(){
			const currentPath = window.location.pathname.replace(/\\/g,'/');
			const marker = '/modules/CatalogoProductos/Views/';
			let basePath = '/';
			const idx = currentPath.indexOf(marker);
			if (idx !== -1) {
				basePath = currentPath.substring(0, idx + 1); // incluye la barra final
			}
			// Base para construir URLs absolutas dentro de la app (e.g., /miapp/)
			window.APP_BASE = basePath;
			// Base para endpoints del módulo
			window.CATALOGO_BASE = basePath + 'modules/CatalogoProductos/';
		})();

		const ENDPOINTS = {
			producto: window.CATALOGO_BASE + 'Controllers/producto_api.php',
			categorias: window.CATALOGO_BASE + 'Controllers/categoria_api.php',
			atributos: window.CATALOGO_BASE + 'Controllers/atributo_api.php',
			imagenes: window.CATALOGO_BASE + 'Controllers/imagenes_producto_api.php',
			prodCategorias: window.CATALOGO_BASE + 'Controllers/productos_categorias_api.php',
			prodAtributos: window.CATALOGO_BASE + 'Controllers/productos_atributos_api.php',
			proveedor: window.CATALOGO_BASE + 'Controllers/proveedor_api.php',
			prodProveedores: window.CATALOGO_BASE + 'Controllers/productos_proveedores_api.php',
			impuestos: window.CATALOGO_BASE + 'Controllers/impuestos_api.php',
			prodImpuestos: window.CATALOGO_BASE + 'Controllers/productos_impuestos_api.php',
			stock: window.CATALOGO_BASE + 'Controllers/stock_api.php',
			movs: window.CATALOGO_BASE + 'Controllers/inventario_movimientos_api.php'
		};

		// Ruta a la vista de inventario
		const INVENTARIO_VIEW = (window.APP_BASE || '/') + 'modules/CatalogoProductos/Views/inventario.html';

		// ===== PROVEEDORES (global: estado y loaders) =====
		// Mover a ámbito global evita errores de referencia cuando cargarProducto() se ejecuta antes de DOMContentLoaded.
		const asignados = new Map(); // id -> { id, nombre }

		function renderAsignados() {
			const cont = document.getElementById('listaProveedoresAsignados');
			if (!cont) return;
			if (!asignados.size) { cont.innerHTML = '<span class="text-muted">Sin proveedores asignados</span>'; return; }
			cont.innerHTML = Array.from(asignados.values()).map(p => {
				const id = escapeHTML(String(p.id));
				const nombre = escapeHTML(String(p.nombre));
				return `<span class="badge text-bg-secondary d-inline-flex align-items-center gap-2" data-id="${id}">
					${id} - ${nombre}
					<button type="button" class="btn btn-sm btn-outline-light" data-action="quitar" data-id="${id}">x</button>
				</span>`;
			}).join('');
		}

		// ===== Inventario (panel rápido) =====
		async function cargarInventarioBasico() {
			const stockEl = document.getElementById('stockDisponibleText');
			const tbody = document.querySelector('#tablaUltimosMovimientos tbody');
			if (!state.productoId) {
				if (stockEl) stockEl.textContent = '-';
				if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="text-muted">Guarda el producto primero.</td></tr>';
				return;
			}
			try {
				// Stock disponible
				const rs = await fetch(`${ENDPOINTS.stock}?disponible=1&id_producto=${encodeURIComponent(String(state.productoId))}`);
				const ds = await rs.json();
				if (rs.ok && (ds.success || ds.ok)) {
					const val = ds.stock_disponible ?? ds.stock ?? ds.disponible ?? ds.data?.stock ?? null;
					if (stockEl) stockEl.textContent = val !== null && val !== undefined ? String(val) : '-';
				} else {
					if (stockEl) stockEl.textContent = '-';
				}
			} catch { if (document.getElementById('stockDisponibleText')) document.getElementById('stockDisponibleText').textContent = '-'; }
			try {
				// Últimos movimientos
				const rm = await fetch(`${ENDPOINTS.movs}?ultimos=1&id_producto=${encodeURIComponent(String(state.productoId))}`);
				const dm = await rm.json();
				const lista = Array.isArray(dm.movimientos) ? dm.movimientos : (Array.isArray(dm.data) ? dm.data : []);
				if (!tbody) return;
				if (!lista.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-muted">Sin datos</td></tr>'; return; }
				tbody.innerHTML = lista.map(m => {
					const fecha = escapeHTML(String(m.fecha ?? m.creado_en ?? ''));
					const tipo = escapeHTML(String(m.tipo ?? m.tipo_movimiento ?? ''));
					const cant = escapeHTML(String(m.cantidad ?? m.cant ?? ''));
					const motivo = escapeHTML(String(m.motivo ?? m.descripcion ?? ''));
					return `<tr><td>${fecha}</td><td>${tipo}</td><td>${cant}</td><td>${motivo}</td></tr>`;
				}).join('');
			} catch {
				if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="text-muted">Sin datos</td></tr>';
			}
		}

		window.cargarProveedoresAsignados = async function() {
			if (!state.productoId) return;
			try {
				const resp = await fetch(`${ENDPOINTS.prodProveedores}?id_producto=${encodeURIComponent(String(state.productoId))}`);
				const data = await resp.json();
				const lista = Array.isArray(data.proveedores) ? data.proveedores : [];
				asignados.clear();
				lista.forEach(p => {
					const id = String(p.id_proveedor ?? p.id ?? '');
					if (!id) return;
					asignados.set(id, { id, nombre: p.nombre ?? '' });
				});
				renderAsignados();
			} catch (err) {
				console.warn('No se pudieron cargar proveedores asignados (puede no existir el endpoint aún).');
			}
		}

		// Buscar productos y mostrar resultados en la tabla del modal
function renderResultadosProductos(lista) {
    const tbody = document.querySelector('#tablaResultadosProductos tbody');
    if (!Array.isArray(lista) || !lista.length) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-muted">Sin resultados</td></tr>';
        return;
    }
    tbody.innerHTML = lista.map(p => {
        const id = escapeHTML(String(p.id_producto ?? p.id ?? ''));
        const nombre = escapeHTML(String(p.nombre ?? ''));
        return `<tr>
            <td>${id}</td>
            <td>${nombre}</td>
            <td><button class="btn btn-sm btn-primary" data-id="${id}" data-action="seleccionar">Editar</button></td>
        </tr>`;
    }).join('');
}

async function buscarProductos(term) {
    const q = (term || '').trim();
    const url = q
        ? `${ENDPOINTS.producto}?buscar=${encodeURIComponent(q)}`
        : `${ENDPOINTS.producto}?listar=1`;
    const resp = await fetch(url);
    const data = await resp.json();
    const lista =
        (Array.isArray(data.productos) && data.productos) ||
        (Array.isArray(data.data) && data.data) ||
        (Array.isArray(data) && data) || [];
    renderResultadosProductos(lista);
}

// Asocia el botón Buscar al evento click
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('btnBuscarProducto').addEventListener('click', () => {
        buscarProductos(document.getElementById('qProducto').value);
    });
    document.getElementById('qProducto').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            buscarProductos(e.target.value);
        }
    });
    // Delegación para seleccionar producto de la tabla
	document.querySelector('#tablaResultadosProductos tbody').addEventListener('click', (e) => {
		const btn = e.target.closest('button[data-action="seleccionar"]');
		if (!btn) return;
		const id = btn.getAttribute('data-id');
		if (!id) return;
		cargarProducto(id);
	});
});

		// ====================================================

		// Validación de Nombre en tiempo real
			// CATEGORÍAS
			async function cargarCategorias() {
			const container = document.getElementById('categoriasContainer');
			if (!state.productoId) {
				container.innerHTML = '<div class="text-muted">Guarda el producto primero.</div>';
				return;
			}
			try {
							// Obtener todas las categorías
							const resp = await fetch(ENDPOINTS.categorias);
							const data = await resp.json();
				if (!resp.ok || !data.success) throw new Error(data.error || 'No se pudieron cargar las categorías');
				const list = Array.isArray(data.categorias) ? data.categorias : [];
				if (!list.length) {
					container.innerHTML = '<div class="text-muted">No hay categorías.</div>';
					return;
				}
							// Obtener categorías asignadas al producto
							let asignadas = new Set();
							try {
								const r2 = await fetch(`${ENDPOINTS.prodCategorias}?id_producto=${encodeURIComponent(String(state.productoId))}`);
								const d2 = await r2.json();
								if (r2.ok && d2.success && Array.isArray(d2.categorias)) {
									asignadas = new Set(d2.categorias.map(x => String(x)));
								}
							} catch {}
				// Render simple lista de checkboxes (sin jerarquía visual compleja)
				const rows = list.map(cat => {
					const id = `cat_${cat.id_categoria}`;
								const checked = asignadas.has(String(cat.id_categoria)) ? 'checked' : '';
								return `<div class="form-check">
										<input class="form-check-input" type="checkbox" value="${escapeHTML(cat.id_categoria)}" id="${escapeHTML(id)}" ${checked}>
							<label class="form-check-label" for="${escapeHTML(id)}">${escapeHTML(cat.nombre)}</label>
						</div>`;
				}).join('');
				container.innerHTML = rows;
			} catch (err) {
				container.innerHTML = `<div class="text-danger">Error: ${escapeHTML(err.message)}</div>`;
			}
		}

			// ATRIBUTOS
			async function cargarAtributos() {
				const tbody = document.querySelector('#tablaAtributos tbody');
				if (!state.productoId) {
					tbody.innerHTML = '<tr><td colspan="3" class="text-muted">Guarda el producto primero.</td></tr>';
					return;
				}
				try {
								const resp = await fetch(ENDPOINTS.atributos);
								const data = await resp.json();
					if (!resp.ok || !data.success) throw new Error(data.error || 'No se pudieron cargar los atributos');
					const list = Array.isArray(data.atributos) ? data.atributos : [];
					if (!list.length) {
						tbody.innerHTML = '<tr><td colspan="3" class="text-muted">No hay atributos.</td></tr>';
						return;
					}
								// Valores asignados al producto
								let valores = new Map();
								try {
									const r2 = await fetch(`${ENDPOINTS.prodAtributos}?id_producto=${encodeURIComponent(String(state.productoId))}`);
									const d2 = await r2.json();
									if (r2.ok && d2.success && Array.isArray(d2.atributos)) {
										d2.atributos.forEach(a => valores.set(String(a.id_atributo), String(a.valor ?? '')));
									}
								} catch {}
					tbody.innerHTML = list.map(a => {
									const val = valores.get(String(a.id_atributo)) ?? '';
									const input = `<input class=\"form-control\" type=\"text\" name=\"valor_${a.id_atributo}\" placeholder=\"Valor\" value=\"${escapeHTML(val)}\" />`;
						return `<tr>
								<td>${escapeHTML(a.nombre)}</td>
								<td>${escapeHTML(a.tipo)}</td>
								<td>${input}</td>
							</tr>`;
					}).join('');
				} catch (err) {
					tbody.innerHTML = `<tr><td colspan=\"3\" class=\"text-danger\">Error: ${escapeHTML(err.message)}</td></tr>`;
				}
			}

			// Cargar imágenes asignadas
			async function cargarImagenes() {
				const tbody = document.querySelector('#tablaImagenes tbody');
				if (!state.productoId) { if (tbody) tbody.innerHTML = ''; return; }
				try {
					const resp = await fetch(`${ENDPOINTS.imagenes}?id_producto=${encodeURIComponent(String(state.productoId))}`);
					const data = await resp.json();
					if (!resp.ok || !data.success) throw new Error(data.error || 'No se pudieron cargar las imágenes');
					const list = Array.isArray(data.imagenes) ? data.imagenes : [];
					state.imagenes = list.map(x => ({ id_imagen: x.id_imagen, archivo: x.archivo, principal: !!x.principal }));
					// Limpiar tabla
					if (window.DataTable && tablaImagenesDT && typeof tablaImagenesDT.clear === 'function') {
						tablaImagenesDT.clear().draw();
						state.imagenes.forEach(item => {
							const imgUrl = (window.APP_BASE || '/') + String(item.archivo).replace(/^\/+/, '');
							tablaImagenesDT.row.add([
								escapeHTML(String(item.id_imagen)),
								`<img src="${escapeHTML(imgUrl)}" alt="img" style="width:64px;height:64px;object-fit:cover;border-radius:4px;">`,
								`<span class="text-truncate" style="max-width:240px;display:inline-block;">${escapeHTML(imgUrl)}</span>`,
								item.principal ? '<span class="badge text-bg-primary">Sí</span>' : 'No'
							]).draw(false);
						});
					} else if (tbody) {
						tbody.innerHTML = '';
						state.imagenes.forEach(item => {
							const tr = document.createElement('tr');
							const imgUrl = (window.APP_BASE || '/') + String(item.archivo).replace(/^\/+/, '');
							tr.innerHTML = [
								escapeHTML(String(item.id_imagen)),
								`<img src="${escapeHTML(imgUrl)}" alt="img" style="width:64px;height:64px;object-fit:cover;border-radius:4px;">`,
								`<span class="text-truncate" style="max-width:240px;display:inline-block;">${escapeHTML(imgUrl)}</span>`,
								item.principal ? '<span class="badge text-bg-primary">Sí</span>' : 'No'
							].map(td => `<td>${td}</td>`).join('');
							tbody.appendChild(tr);
						});
					}
				} catch (err) {
					if (tbody) tbody.innerHTML = `<tr><td colspan="4" class="text-danger">Error: ${escapeHTML(err.message)}</td></tr>`;
				}
			}

			// Cargar un producto completo para edición
			async function cargarProducto(id) {
				try {
					const resp = await fetch(`${ENDPOINTS.producto}?id=${encodeURIComponent(String(id))}`);
					const data = await resp.json();
					if (!resp.ok || !data.success || !data.producto) throw new Error(data.error || 'No se pudo obtener el producto');
					const p = data.producto;
					state.productoId = p.id_producto || id;
					// Rellenar formulario
					document.getElementById('nombre').value = p.nombre ?? '';
					document.getElementById('descripcion').value = p.descripcion ?? '';
					document.getElementById('precio').value = p.precio ?? '';
					document.getElementById('stock').value = p.stock ?? '';
					document.getElementById('stock_minimo').value = p.stock_minimo ?? '';
					document.getElementById('estado').value = (p.estado === 1 || p.estado === '1' || p.estado === 'activo') ? 'activo' : 'inactivo';
					['nombre','precio','stock','stock_minimo','estado'].forEach(id => document.getElementById(id).classList.remove('is-invalid'));
					// Badge
					document.getElementById('productoIdText').textContent = String(state.productoId);
					document.getElementById('productoIdBadge').classList.remove('d-none');
					// Habilitar tabs
					['tab-categorias','tab-atributos','tab-impuestos','tab-proveedores','tab-imagenes'].forEach(id => {
						const el = document.getElementById(id);
						el.classList.remove('disabled');
						el.removeAttribute('aria-disabled');
					});
					document.getElementById('datosAyuda').classList.add('d-none');
					// Cargar datos relacionados
					await Promise.all([
						cargarCategorias(),
						cargarAtributos(),
						window.cargarProveedoresAsignados?.(),
						cargarImagenes()
					]);
					// Inventario: mostrar panel y cargar resumen
					document.getElementById('panelInventario')?.classList.remove('d-none');
					cargarInventarioBasico();
					// Cerrar modal si está abierto
					const modalEl = document.getElementById('modalBuscarProducto');
					if (modalEl && window.bootstrap?.Modal) {
						const inst = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
						inst.hide();
					}
				} catch (err) {
					alert('Error al cargar producto: ' + err.message);
				}
			}

			// IMÁGENES
			let tablaImagenesDT;

			// INIT ÚNICO
			document.addEventListener('DOMContentLoaded', () => {
				// Botón Añadir nuevo producto
				document.getElementById('btnNuevoProducto').addEventListener('click', () => {
					// Limpiar formulario principal
					document.getElementById('productoForm').reset();
					['nombre','precio','stock','stock_minimo','estado'].forEach(id => document.getElementById(id).classList.remove('is-invalid'));
					// Limpiar badge de ID
					document.getElementById('productoIdBadge').classList.add('d-none');
					document.getElementById('productoIdText').textContent = '';
					// Deshabilitar tabs
					['tab-categorias','tab-atributos','tab-impuestos','tab-proveedores','tab-imagenes'].forEach(id => {
						const el = document.getElementById(id);
						el.classList.add('disabled');
						el.setAttribute('aria-disabled', 'true');
					});
					// Limpiar contenido de los tabs
					document.getElementById('categoriasContainer').innerHTML = '<div class="text-muted">Guarda el producto primero.</div>';
					document.querySelector('#tablaAtributos tbody').innerHTML = '<tr><td colspan="3" class="text-muted">Guarda el producto primero.</td></tr>';
					document.getElementById('listaProveedoresAsignados').innerHTML = '<span class="text-muted">Sin proveedores asignados</span>';
					document.querySelector('#tablaResultadosProveedores tbody').innerHTML = '<tr><td colspan="3" class="text-muted">Sin resultados</td></tr>';
					// Limpiar imágenes
					const tbodyImg = document.querySelector('#tablaImagenes tbody');
					if (tbodyImg) tbodyImg.innerHTML = '';
					if (window.DataTable && tablaImagenesDT && typeof tablaImagenesDT.clear === 'function') {
						tablaImagenesDT.clear().draw();
					}
					// Limpiar estado
					state.productoId = null;
					state.imagenes = [];
					// Panel inventario: ocultar y limpiar
					document.getElementById('panelInventario')?.classList.add('d-none');
					const stockEl = document.getElementById('stockDisponibleText');
					if (stockEl) stockEl.textContent = '-';
					const tbodyMov = document.querySelector('#tablaUltimosMovimientos tbody');
					if (tbodyMov) tbodyMov.innerHTML = '<tr><td colspan="4" class="text-muted">Sin datos</td></tr>';
					// Mostrar ayuda
					document.getElementById('datosAyuda').classList.remove('d-none');
				});
				// Validación de nombre
				const nombre = document.getElementById('nombre');
				const re = /^[\p{L}\p{N}\s.,\-_&]{1,100}$/u; // letras (incluye acentos), números, espacios y . , - _ &
				function validateNombre() {
					const value = nombre.value.trim();
					const valid = re.test(value);
					nombre.classList.toggle('is-invalid', !valid);
					return valid;
				}
				nombre.addEventListener('input', validateNombre);
				nombre.addEventListener('blur', validateNombre);

				// Cargar al mostrar cada tab
				const tabCategorias = document.getElementById('tab-categorias');
				const tabAtributos = document.getElementById('tab-atributos');
				const tabProveedores = document.getElementById('tab-proveedores');
				const tabImpuestos = document.getElementById('tab-impuestos');
				tabCategorias?.addEventListener('shown.bs.tab', () => { if (state.productoId) cargarCategorias(); });
				tabAtributos?.addEventListener('shown.bs.tab', () => { if (state.productoId) cargarAtributos(); });
				tabImpuestos?.addEventListener('shown.bs.tab', () => { if (state.productoId) cargarUIImpuestos(); });
					tabProveedores?.addEventListener('shown.bs.tab', () => {
					if (state.productoId) {
						window.cargarProveedoresAsignados?.();
						// Refresca la tabla de resultados para alinear los botones Agregar/Quitar con los asignados
						const qv = document.getElementById('qProveedor')?.value || '';
							try { if (typeof buscarProveedores === 'function') buscarProveedores(qv); } catch (e) {}
					}
				});

				// ===== IMPUESTOS (helpers y eventos) =====
				const selImp = document.getElementById('pg_imp_sel');
				const btnAddImp = document.getElementById('pg_imp_add');
				const tbodyImp = document.getElementById('pg_imp_tbody');

				function fmtTipoValor(tipo, valor){
					return tipo === 'fijo' ? `fijo ${Number(valor||0).toFixed(2)}` : `porcentaje ${Number(valor||0).toFixed(2)}%`;
				}

				async function loadImpuestosActivos(){
					// Intentar usar ?listar=1&activo=1; si el backend no lo filtra, filtramos aquí
					const d = await apiFetch(`${ENDPOINTS.impuestos}?listar=1&activo=1`, { method: 'GET' });
					const lista = Array.isArray(d.impuestos) ? d.impuestos : (Array.isArray(d.data) ? d.data : []);
					const activos = lista.filter(i => (i.activo===1||i.activo==='1'||i.activo===true));
					return activos;
				}

				async function loadImpuestosAsignados(){
					if (!state.productoId) return [];
					const d = await apiFetch(`${ENDPOINTS.prodImpuestos}?id_producto=${encodeURIComponent(String(state.productoId))}`, { method: 'GET' });
					const lista = Array.isArray(d.impuestos) ? d.impuestos : (Array.isArray(d.data) ? d.data : []);
					return lista;
				}

				function renderAsignadosImpuestos(asignados){
					if (!tbodyImp) return;
					if (!asignados.length){ tbodyImp.innerHTML = '<tr><td colspan="6" class="text-muted">Sin datos</td></tr>'; return; }
					tbodyImp.innerHTML = asignados.map(it => {
						const idImp = String(it.id_impuesto ?? it.id ?? '');
						const codigo = escapeHTML(String(it.codigo ?? ''));
						const nombre = escapeHTML(String(it.nombre ?? ''));
						const tipo = escapeHTML(String(it.tipo ?? 'porcentaje'));
						const valor = escapeHTML(String(Number(it.valor ?? 0).toFixed(2)));
						const aplica = escapeHTML(String(it.aplica_sobre ?? 'base_descuento'));
						return `<tr data-id="${escapeHTML(idImp)}">
							<td>${codigo}</td>
							<td>${nombre}</td>
							<td>${tipo}</td>
							<td>${valor}</td>
							<td>${aplica}</td>
							<td><button class="btn btn-sm btn-outline-danger" data-action="quitar" data-id="${escapeHTML(idImp)}">Quitar</button></td>
						</tr>`;
					}).join('');
				}

				function actualizarOpcionesSelectImpuestos(activos, asignados){
					if (!selImp) return;
					const asignadosSet = new Set(asignados.map(x => String(x.id_impuesto ?? x.id ?? '')));
					selImp.innerHTML = '<option value="">-- Selecciona --</option>' + activos.map(i => {
						const id = String(i.id_impuesto ?? i.id ?? '');
						const disabled = asignadosSet.has(id) ? 'disabled' : '';
						const label = `${escapeHTML(String(i.codigo||''))} - ${escapeHTML(String(i.nombre||''))} (${escapeHTML(fmtTipoValor(String(i.tipo||'porcentaje'), i.valor))}, ${escapeHTML(String(i.aplica_sobre||'base_descuento'))})`;
						return `<option value="${escapeHTML(id)}" ${disabled}>${label}</option>`;
					}).join('');
					btnAddImp.disabled = !selImp.value;
				}

				async function cargarUIImpuestos(){
					if (!state.productoId) {
						if (tbodyImp) tbodyImp.innerHTML = '<tr><td colspan="6" class="text-muted">Guarda el producto primero.</td></tr>';
						btnAddImp.disabled = true; return;
					}
					try{
						const [activos, asignados] = await Promise.all([
							loadImpuestosActivos(),
							loadImpuestosAsignados()
						]);
						renderAsignadosImpuestos(asignados);
						actualizarOpcionesSelectImpuestos(activos, asignados);
					} catch(err){
						alert('Error cargando impuestos: ' + err.message);
					}
				}

				selImp?.addEventListener('change', ()=>{ btnAddImp.disabled = !selImp.value; });
				document.getElementById('btnRefrescarImpuestos')?.addEventListener('click', ()=>{ if(state.productoId) cargarUIImpuestos(); });

				btnAddImp?.addEventListener('click', async ()=>{
					if (!state.productoId) return alert('Primero guarda el producto');
					const idImp = selImp.value;
					if (!idImp) return;
					try{
						const data = await apiFetch(ENDPOINTS.prodImpuestos, { method:'POST', body: JSON.stringify({ id_producto: Number(state.productoId), id_impuesto: Number(idImp) }) });
						cargarUIImpuestos();
					} catch(err){
						alert('Error al asignar: ' + err.message);
					}
				});

				document.getElementById('pg_imp_tbl')?.addEventListener('click', async (e)=>{
					const btn = e.target.closest('button[data-action="quitar"]');
					if (!btn) return;
					if (!state.productoId) return;
					const idImp = String(btn.getAttribute('data-id'));
					try{
						const url = `${ENDPOINTS.prodImpuestos}?id_producto=${encodeURIComponent(String(state.productoId))}&id_impuesto=${encodeURIComponent(idImp)}`;
						const data = await apiFetch(url, { method:'DELETE' });
						cargarUIImpuestos();
					} catch(err){
						alert('Error al quitar: ' + err.message);
					}
				});

				// Submit Producto
				const form = document.getElementById('productoForm');
				form.addEventListener('submit', async (e) => {
					e.preventDefault();
					let valid = true;
					if (!validateNombre()) valid = false;

					const precio = document.getElementById('precio');
					const stock = document.getElementById('stock');
					const estado = document.getElementById('estado');
					const stockMin = document.getElementById('stock_minimo');

					if (!precio.value || Number(precio.value) < 0) { precio.classList.add('is-invalid'); valid = false; } else { precio.classList.remove('is-invalid'); }
					if (!stock.value || Number(stock.value) < 0)  { stock.classList.add('is-invalid'); valid = false; } else { stock.classList.remove('is-invalid'); }
					if (!estado.value) { estado.classList.add('is-invalid'); valid = false; } else { estado.classList.remove('is-invalid'); }
					if (stockMin.value && Number(stockMin.value) < 0) { stockMin.classList.add('is-invalid'); valid = false; } else { stockMin.classList.remove('is-invalid'); }

					if (!valid) return;

					// Usamos x-www-form-urlencoded para ser compatibles con producto_api.php (parse_str en PUT)
					const payload = new URLSearchParams();
					payload.set('nombre', document.getElementById('nombre').value.trim());
					payload.set('descripcion', document.getElementById('descripcion').value.trim());
					payload.set('precio', precio.value);
					payload.set('stock', stock.value);
					payload.set('stock_minimo', stockMin.value || '0');
					payload.set('estado', estado.value);

					try {
						let resp, data;
						if (state.productoId) {
							// Actualizar existente via PUT ?id=...
							resp = await fetch(`${ENDPOINTS.producto}?id=${encodeURIComponent(String(state.productoId))}`,
								{ method: 'PUT', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: payload.toString() }
							);
							data = await resp.json();
							if (!resp.ok || !data.success) throw new Error(data.error || 'No se pudo actualizar');
							// Mantener badge y tabs habilitados
							document.getElementById('productoIdText').textContent = String(state.productoId);
							document.getElementById('productoIdBadge').classList.remove('d-none');
							['tab-categorias','tab-atributos','tab-impuestos','tab-proveedores','tab-imagenes'].forEach(id => {
								const el = document.getElementById(id);
								el.classList.remove('disabled');
								el.removeAttribute('aria-disabled');
							});
							document.getElementById('datosAyuda').classList.add('d-none');
							// Inventario: mostrar panel y recargar datos
							document.getElementById('panelInventario')?.classList.remove('d-none');
							cargarInventarioBasico();
							if (window.bootstrap?.Toast) showToast('Producto actualizado correctamente');
						} else {
							// Crear nuevo via POST
							resp = await fetch(ENDPOINTS.producto,
								{ method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: payload.toString() }
							);
							data = await resp.json();
							if (!resp.ok || !data.success) throw new Error(data.error || 'No se pudo guardar');
							state.productoId = data.id;
							document.getElementById('productoIdText').textContent = String(state.productoId);
							document.getElementById('productoIdBadge').classList.remove('d-none');
							['tab-categorias','tab-atributos','tab-impuestos','tab-proveedores','tab-imagenes'].forEach(id => {
								const el = document.getElementById(id);
								el.classList.remove('disabled');
								el.removeAttribute('aria-disabled');
							});
							document.getElementById('datosAyuda').classList.add('d-none');
							// Precargar categorías y atributos ahora que ya hay ID
							cargarCategorias();
							cargarAtributos();
							window.cargarProveedoresAsignados?.();
							// Mostrar panel de inventario y cargar datos
							document.getElementById('panelInventario')?.classList.remove('d-none');
							cargarInventarioBasico();
							if (window.bootstrap?.Toast) showToast('Producto guardado correctamente');
						}
					} catch (err) {
						alert('Error: ' + err.message);
					}
				});

				// Botón ver inventario con filtros del producto
				document.getElementById('btnVerInventario')?.addEventListener('click', () => {
					if (!state.productoId) return;
					const url = `${INVENTARIO_VIEW}?tab=movs&id_producto=${encodeURIComponent(String(state.productoId))}`;
					window.location.href = url;
				});

				// Limpiar formulario
				document.getElementById('btnLimpiar').addEventListener('click', () => {
					document.getElementById('productoForm').reset();
					['nombre','precio','stock','stock_minimo','estado'].forEach(id => document.getElementById(id).classList.remove('is-invalid'));
				});

				// ===== PROVEEDORES =====
				function renderResultadosProveedores(lista) {
					const tbody = document.querySelector('#tablaResultadosProveedores tbody');
					if (!tbody) return;
					if (!Array.isArray(lista) || !lista.length) { tbody.innerHTML = '<tr><td colspan="3" class="text-muted">Sin resultados</td></tr>'; return; }
					tbody.innerHTML = lista.map(item => {
						const id = escapeHTML(String(item.id_proveedor ?? item.id ?? ''));
						const nombre = escapeHTML(String(item.nombre ?? ''));
						const ya = asignados.has(String(item.id_proveedor ?? item.id ?? ''));
						return `<tr>
							<td>${id}</td>
							<td>${nombre}</td>
							<td>
								<button class="btn btn-sm ${ya ? 'btn-outline-danger' : 'btn-outline-primary'}" data-action="${ya ? 'quitar' : 'agregar'}" data-id="${id}" data-nombre="${nombre}">
									${ya ? 'Quitar' : 'Agregar'}
								</button>
							</td>
						</tr>`;
					}).join('');
				}

				async function buscarProveedores(term) {
					if (!state.productoId) return alert('Primero guarda el producto');
					const q = (term || '').trim();
					if (q.length > 100) { alert('La búsqueda es demasiado larga'); return; }
					const url = q ? `${ENDPOINTS.proveedor}?buscar=${encodeURIComponent(q)}` : `${ENDPOINTS.proveedor}?listar=1`;
					try {
						const resp = await fetch(url);
						const data = await resp.json();
						const lista = Array.isArray(data.proveedores) ? data.proveedores : (Array.isArray(data.data) ? data.data : []);
						renderResultadosProveedores(lista);
					} catch (err) {
						console.error('Error buscando proveedores', err);
					}
				}

				// window.cargarProveedoresAsignados ya está definido en ámbito global

				const btnBuscarProv = document.getElementById('btnBuscarProveedor');
				btnBuscarProv?.addEventListener('click', () => {
					buscarProveedores(document.getElementById('qProveedor').value);
				});
				document.getElementById('qProveedor')?.addEventListener('keydown', (e) => {
					if (e.key === 'Enter') { e.preventDefault(); buscarProveedores(e.target.value); }
				});

				document.querySelector('#tablaResultadosProveedores tbody')?.addEventListener('click', (e) => {
					const btn = e.target.closest('button[data-action]');
					if (!btn) return;
					const id = String(btn.getAttribute('data-id'));
					const nombre = btn.getAttribute('data-nombre') || '';
					if (btn.getAttribute('data-action') === 'agregar') {
						asignados.set(id, { id, nombre });
					} else {
						asignados.delete(id);
					}
					renderAsignados();
					buscarProveedores(document.getElementById('qProveedor').value);
				});

				document.getElementById('listaProveedoresAsignados')?.addEventListener('click', (e) => {
					const btn = e.target.closest('button[data-action="quitar"]');
					if (!btn) return;
					const id = String(btn.getAttribute('data-id'));
					asignados.delete(id);
					renderAsignados();
				});

				document.getElementById('btnGuardarProveedores')?.addEventListener('click', async () => {
					if (!state.productoId) return alert('Primero guarda el producto');
					const ids = Array.from(asignados.keys());
					try {
						const payload = new URLSearchParams();
						payload.set('id_producto', String(state.productoId));
						ids.forEach(id => payload.append('proveedores[]', id));
						const resp = await fetch(ENDPOINTS.prodProveedores, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: payload.toString() });
						const data = await resp.json();
						if (!resp.ok || !data.success) throw new Error(data.error || 'No se pudo guardar la relación');
						alert('Relación guardada');
					} catch (err) {
						alert('Error al guardar relación: ' + err.message);
					}
				});

				// Botones Categorías
				document.getElementById('btnRefrescarCategorias').addEventListener('click', cargarCategorias);
				document.getElementById('btnGuardarCategorias').addEventListener('click', async () => {
					if (!state.productoId) return alert('Primero guarda el producto');
					const selected = Array.from(document.querySelectorAll('#categoriasContainer input[type="checkbox"]:checked')).map(ch => ch.value);
					if (!selected.length) return alert('Selecciona al menos una categoría');
					try {
						const payload = new URLSearchParams();
						payload.set('id_producto', String(state.productoId));
						selected.forEach(idc => payload.append('categorias[]', idc));
						const resp = await fetch(ENDPOINTS.prodCategorias, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: payload.toString() });
						const data = await resp.json();
						if (!resp.ok || !data.success) throw new Error(data.error || 'No se pudo guardar la relación');
						alert('Categorías guardadas');
					} catch (err) {
						alert('Error (configura el endpoint productos_categorias_api.php): ' + err.message);
					}
				});
				// Botones Atributos
				document.getElementById('btnRefrescarAtributos').addEventListener('click', cargarAtributos);
				document.getElementById('btnGuardarAtributos').addEventListener('click', async () => {
					if (!state.productoId) return alert('Primero guarda el producto');
					const rows = Array.from(document.querySelectorAll('#tablaAtributos tbody tr'));
					const valores = [];
					rows.forEach((tr) => {
						const nombre = tr.children[0].textContent.trim();
						const tipo = tr.children[1].textContent.trim();
						const input = tr.querySelector('input');
						const valor = input ? input.value.trim() : '';
						const idMatch = input?.name?.match(/valor_(\d+)/);
						if (idMatch && valor) valores.push({ id_atributo: idMatch[1], valor });
					});
					if (!valores.length) return alert('Ingresa al menos un valor');
					try {
						const payload = new URLSearchParams();
						payload.set('id_producto', String(state.productoId));
						valores.forEach(v => {
							payload.append('atributos[]', JSON.stringify(v));
						});
						const resp = await fetch(ENDPOINTS.prodAtributos, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: payload.toString() });
						const data = await resp.json();
						if (!resp.ok || !data.success) throw new Error(data.error || 'No se pudieron guardar los atributos');
						alert('Atributos guardados');
					} catch (err) {
						alert('Error (configura el endpoint productos_atributos_api.php): ' + err.message);
					}
				});
				// Subida de imágenes (registramos primero el handler para que un fallo previo no lo bloquee)
				const imgForm = document.getElementById('imagenForm');
				imgForm.addEventListener('submit', async (e) => {
					e.preventDefault();
					if (!state.productoId) return alert('Primero guarda el producto');
					const fileInput = document.getElementById('archivo_imagen');
					if (!fileInput.files || !fileInput.files.length) { fileInput.classList.add('is-invalid'); return; }
					fileInput.classList.remove('is-invalid');

					const fd = new FormData(imgForm);
					fd.set('id_producto', String(state.productoId));
					fd.set('principal', document.getElementById('principal').checked ? '1' : '0');
					try {
						const resp = await fetch(ENDPOINTS.imagenes, { method: 'POST', body: fd });
						const data = await resp.json();
						if (!resp.ok || !data.success) throw new Error(data.error || 'No se pudo subir la imagen');
						// Guardar en estado y renderizar
						const item = { id_imagen: data.id, archivo: data.archivo, principal: fd.get('principal') === '1' };
						state.imagenes.push(item);
						if (window.DataTable && tablaImagenesDT && typeof tablaImagenesDT.row?.add === 'function') {
							const imgUrl = (window.APP_BASE || '/') + String(item.archivo).replace(/^\/+/, '');
							tablaImagenesDT.row.add([
								escapeHTML(String(item.id_imagen)),
								`<img src="${escapeHTML(imgUrl)}" alt="img" style="width:64px;height:64px;object-fit:cover;border-radius:4px;">`,
								`<span class="text-truncate" style="max-width:240px;display:inline-block;">${escapeHTML(imgUrl)}</span>`,
								item.principal ? '<span class="badge text-bg-primary">Sí</span>' : 'No'
							]).draw(false);
						} else {
							// Fallback sin DataTables: agrega una fila al tbody
							const tbody = document.querySelector('#tablaImagenes tbody');
							const tr = document.createElement('tr');
							const imgUrl = (window.APP_BASE || '/') + String(item.archivo).replace(/^\/+/, '');
							tr.innerHTML = [
								escapeHTML(String(item.id_imagen)),
								`<img src="${escapeHTML(imgUrl)}" alt="img" style="width:64px;height:64px;object-fit:cover;border-radius:4px;">`,
								`<span class="text-truncate" style="max-width:240px;display:inline-block;">${escapeHTML(imgUrl)}</span>`,
								item.principal ? '<span class="badge text-bg-primary">Sí</span>' : 'No'
							].map(td => `<td>${td}</td>`).join('');
							tbody.appendChild(tr);
						}
						imgForm.reset();
					} catch (err) {
						alert('Error: ' + err.message);
					}
				});

				// DataTable Imágenes (no bloqueante)
				try {
					if (window.DataTable) {
						tablaImagenesDT = new DataTable('#tablaImagenes', {
							paging: false,
							searching: false,
							info: false,
							language: { url: 'https://cdn.datatables.net/plug-ins/2.0.7/i18n/es-ES.json' }
						});
					} else {
						console.warn('DataTable no disponible; se usará tabla simple');
					}
				} catch (err) {
					console.error('Error inicializando DataTable de imágenes:', err);
				}
			});

		// Utilidad opcional para toasts (si el layout tiene toasts de Bootstrap)
		function showToast(message) {
			try {
				const toastEl = document.createElement('div');
				toastEl.className = 'toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-3';
				toastEl.setAttribute('role', 'alert');
				toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">${escapeHTML(message)}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
				document.body.appendChild(toastEl);
				const toast = new bootstrap.Toast(toastEl, { delay: 2000 });
				toast.show();
				toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
			} catch {}
		}

async function apiFetch(url, opts={}) {
  const headers = {
    'Content-Type':'application/json',
    'Authorization': `Bearer ${authToken}`
  };
  const res = await fetch(url, {...opts, headers});
  if (res.status === 401 || res.status === 403) {
    alert('Sesión expirada o sin permisos. Redirigiendo a login...');
    localStorage.removeItem('authToken');
    window.location.href = '../../GestionUsuarios/Views/login.html';
    throw new Error('No autorizado');
  }
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

	</script>

	<!-- Layout scripts -->
	<script src="../../Shared/Assets/js/layout.js"></script>
	<script>
		// Cargar sidebar
		fetch('../../Shared/Views/sidebar.html')
			.then(r => r.text())
			.then(html => {
				document.getElementById('layoutContainer').innerHTML = html;
				// Inicializar layout después de cargar el sidebar
				initLayout();
			});
	</script>
</body>
</html>
