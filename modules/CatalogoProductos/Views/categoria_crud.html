<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n de Categor√≠as</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="catalogo.css">
</head>
<body>
    <!-- Mensaje de acceso denegado -->
    <div id="accessDenied" class="container mt-5" style="display: none;">
        <div class="alert alert-danger text-center">
            <h4>‚ö†Ô∏è Acceso Restringido</h4>
            <p>Roles requeridos: ADMINISTRADOR o GESTOR_CONTENIDOS</p>
        </div>
    </div>

    <!-- Contenido principal -->
    <div id="mainContent" style="display: none;">
    <div class="rounded shadow-sm d-flex align-items-center justify-content-between px-4 py-3 mb-4" style="background-color: rgb(232,232,232); color: #333;">
        <h1 class="mb-0" style="font-size:1.7rem;">Gesti√≥n de Categor√≠as</h1>
        <div class="d-flex align-items-center gap-3">
            <span id="userInfo" class="text-muted small"></span>
            <button id="btnLogout" class="btn btn-outline-danger btn-sm">Cerrar Sesi√≥n</button>
            <button id="btnMostrarForm" type="button" class="btn btn-success fw-bold">
                <span class="me-2">‚ûï</span> A√±adir
            </button>
        </div>
    </div>
    <form id="categoriaForm" class="card p-4 mb-4 shadow-sm" style="display:none; max-width: 400px;">
        <div style="background:#d7d8e5; border-radius:6px; padding:10px; margin-bottom:18px;">
            <h4 id="formTitulo" class="mb-0 fw-bold text-center"></h4>
        </div>
        <div class="mb-3">
            <label for="nombre" class="form-label mb-1"><strong>Nombre de la categor√≠a</strong></label>
            <input type="text" id="nombre" name="nombre" maxlength="100" required class="form-control">
            <span id="nombreError" class="text-danger small"></span>
        </div>
        <div class="mb-3">
            <label for="descripcion" class="form-label mb-1"><strong>Descripci√≥n</strong></label>
            <textarea id="descripcion" name="descripcion" class="form-control" rows="2"></textarea>
        </div>
        <div class="mb-3">
            <label for="id_categoria_padre" class="form-label mb-1"><strong>Categor√≠a padre (ID)</strong></label>
            <input type="number" id="id_categoria_padre" name="id_categoria_padre" class="form-control" placeholder="(vac√≠o si es principal)">
        </div>
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-fill">Guardar</button>
            <button type="button" id="btnCancelarForm" class="btn btn-secondary flex-fill">Cancelar</button>
        </div>
    </form>
    <div class="container mt-4">
        <div class="row mb-3 align-items-end">
            <div class="col-12">
                <div style="background:#f4f4fa; border-radius:8px; border:1px solid #d7d8e5; padding:18px;" class="mb-2">
                    <div class="d-flex align-items-center flex-nowrap gap-3 w-100 mb-2">
                        <label for="filtroCampo" class="form-label mb-0" style="white-space:nowrap;">Filtro campo:</label>
                        <select id="filtroCampo" class="form-select flex-grow-1" style="min-width:180px;max-width:300px;">
                            <option value="nombre">Nombre</option>
                            <option value="descripcion">Descripci√≥n</option>
                            <option value="id_categoria">ID</option>
                        </select>
                        <div class="d-flex ms-auto align-items-center" style="min-width:220px;">
                            <label for="ordenCampo" class="form-label mb-0 me-2" style="white-space:nowrap;">Orden:</label>
                            <select id="ordenCampo" class="form-select" style="min-width:120px;max-width:180px;">
                                <option value="asc">Ascendente</option>
                                <option value="desc">Descendente</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-flex align-items-center flex-nowrap gap-2 w-100 mt-2">
                        <label for="busqueda" class="form-label mb-0" style="white-space:nowrap;">Buscar:</label>
                        <input type="text" id="busqueda" class="form-control flex-grow-1" placeholder="Buscar..." style="min-width:180px;max-width:300px;">
                    </div>
                </div>
            </div>
        </div>
        <table id="tablaCategorias" class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>#</th>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Descripci√≥n</th>
                    <th>Padre</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    </div><!-- End mainContent -->
    <script>
    // ==================== AUTENTICACI√ìN Y AUTORIZACI√ìN ====================
    
    const ROLES_PERMITIDOS = ['ADMINISTRADOR', 'GESTOR_CONTENIDOS'];
    let currentUser = null;
    let authToken = null;

    (async function verificarAcceso() {
      try {
        authToken = localStorage.getItem('authToken');
        if (!authToken) throw new Error('No hay sesi√≥n activa');
        
        const response = await fetch('/modules/GestionUsuarios/Api/index.php?action=perfil', {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) throw new Error('Token inv√°lido o expirado');
        
        const data = await response.json();
        currentUser = data.datos ? data.datos.usuario : data.usuario;
        
        // Verificar usuario activo
        if (currentUser.activo !== 1 || currentUser.estado_id !== 1) {
          throw new Error('Usuario no est√° activo');
        }
        
        // Verificar roles
        const userRoles = currentUser.roles.split(',').map(r => r.trim());
        const tieneAcceso = userRoles.some(rol => ROLES_PERMITIDOS.includes(rol));
        
        if (!tieneAcceso) throw new Error('Rol no autorizado');
        
        // Mostrar contenido
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('accessDenied').style.display = 'none';
        document.getElementById('userInfo').textContent = `${currentUser.nombre_completo} (${userRoles.join(', ')})`;
        
      } catch (error) {
        console.error('Error de autenticaci√≥n:', error);
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('accessDenied').style.display = 'block';
        
        setTimeout(() => {
          localStorage.removeItem('authToken');
          window.location.href = '../../GestionUsuarios/Views/login.html';
        }, 3000);
      }
    })();

    // Cerrar sesi√≥n
    document.getElementById('btnLogout')?.addEventListener('click', () => {
      localStorage.removeItem('authToken');
      window.location.href = '../../GestionUsuarios/Views/login.html';
    });

    // Helper para fetch con autenticaci√≥n
    async function apiFetch(url, options = {}) {
      const headers = {
        'Authorization': `Bearer ${authToken}`,
        ...options.headers
      };
      
      const response = await fetch(url, { ...options, headers });
      
      if (response.status === 401 || response.status === 403) {
        alert('Sesi√≥n expirada o sin permisos. Redirigiendo a login...');
        localStorage.removeItem('authToken');
        window.location.href = '../../GestionUsuarios/Views/login.html';
        throw new Error('No autorizado');
      }
      
      return response;
    }

    // ==================== L√ìGICA DEL M√ìDULO ====================
    
    let categorias = [];
    function renderCategorias() {
        const campo = document.getElementById('filtroCampo').value;
        const busqueda = document.getElementById('busqueda').value.toLowerCase();
        const orden = document.getElementById('ordenCampo').value;
        let filtrados = categorias.filter(cat => {
            if (!busqueda) return true;
            let valor = (cat[campo] || '').toString().toLowerCase();
            return valor.includes(busqueda);
        });
        filtrados.sort((a, b) => {
            let va = (a[campo] || '').toString().toLowerCase();
            let vb = (b[campo] || '').toString().toLowerCase();
            if (campo === 'id_categoria') {
                va = parseInt(a[campo]);
                vb = parseInt(b[campo]);
                if (isNaN(va)) va = 0;
                if (isNaN(vb)) vb = 0;
            }
            if (va < vb) return orden === 'asc' ? -1 : 1;
            if (va > vb) return orden === 'asc' ? 1 : -1;
            return 0;
        });
        const tbody = document.querySelector('#tablaCategorias tbody');
        tbody.innerHTML = '';
        function escapeHtml(text) {
            return text.replace(/[&<>'"`=]/g, function (c) {
                return {'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;','`':'&#96;','=':'&#61;'}[c];
            });
        }
        filtrados.forEach((cat, i) => {
            tbody.innerHTML += `<tr>
                <td>${i+1}</td>
                <td>${escapeHtml(cat.id_categoria.toString())}</td>
                <td>${escapeHtml(cat.nombre)}</td>
                <td>${escapeHtml(cat.descripcion)}</td>
                <td>${cat.id_categoria_padre ?? 'Ninguno'}</td>
                <td>
                    <button title='Ver' onclick='verCategoria(${escapeHtml(cat.id_categoria.toString())})'>üîç</button>
                    <button title='Editar' onclick='editarCategoria(${escapeHtml(cat.id_categoria.toString())})'>‚úèÔ∏è</button>
                    <button title='Eliminar' onclick='eliminarCategoria(${escapeHtml(cat.id_categoria.toString())})'>‚ùå</button>
                </td>
            </tr>`;
        });
        $('#tablaCategorias').DataTable({
            destroy: true,
            searching: false,
            paging: true,
            info: false,
            pageLength: 10,
            lengthChange: false
        });
    }
    function cargarCategorias() {
        apiFetch('../Controllers/categoria_api.php')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    categorias = data.categorias;
                    renderCategorias();
                }
            })
            .catch(err => console.error('Error al cargar categor√≠as:', err));
    }
    document.getElementById('filtroCampo').addEventListener('change', renderCategorias);
    document.getElementById('ordenCampo').addEventListener('change', renderCategorias);
    document.getElementById('busqueda').addEventListener('input', renderCategorias);

    // CRUD funcional
    const btnMostrarForm = document.getElementById('btnMostrarForm');
    const categoriaForm = document.getElementById('categoriaForm');
    const btnCancelarForm = document.getElementById('btnCancelarForm');

    btnMostrarForm.addEventListener('click', function() {
        categoriaForm.style.display = 'flex';
        document.getElementById('formTitulo').textContent = 'A√±adir categor√≠a';
        btnMostrarForm.disabled = true;
        document.getElementById('filtroCampo').disabled = true;
        document.getElementById('ordenCampo').disabled = true;
        document.getElementById('busqueda').disabled = true;
        document.getElementById('tablaCategorias').classList.add('table-disabled');
    });

    btnCancelarForm.addEventListener('click', function() {
        categoriaForm.style.display = 'none';
        btnMostrarForm.disabled = false;
        document.getElementById('filtroCampo').disabled = false;
        document.getElementById('ordenCampo').disabled = false;
        document.getElementById('busqueda').disabled = false;
        document.getElementById('tablaCategorias').classList.remove('table-disabled');
        document.getElementById('nombre').disabled = false;
        document.getElementById('descripcion').disabled = false;
        document.getElementById('id_categoria_padre').disabled = false;
        categoriaForm.querySelector('button[type="submit"]').disabled = false;
    });

    let modoEdicion = false;
    let idEdicion = null;
    categoriaForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const form = this;
        const nombre = form.nombre.value.trim();
        const regex = /^[\w\s√°√©√≠√≥√∫√Å√â√ç√ì√ö√º√ú√±√ë.,-]{1,100}$/;
        if (!regex.test(nombre)) {
            alert('Nombre inv√°lido. Solo letras, n√∫meros y algunos signos permitidos. M√°x 100 caracteres.');
            form.nombre.focus();
            return;
        }
        const datos = new FormData(form);
        // Si el campo est√° vac√≠o, no modificar el valor; el backend debe procesar el valor vac√≠o
        let url = '../Controllers/categoria_api.php';
        let fetchConfig = { method: 'POST', body: datos };
        if (modoEdicion && idEdicion) {
            datos.append('id', idEdicion);
            url += '?id=' + idEdicion;
            fetchConfig = { method: 'PUT', body: new URLSearchParams(datos) };
        }
        apiFetch(url, fetchConfig)
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    alert(modoEdicion ? 'Categor√≠a actualizada' : 'Categor√≠a guardada con ID: ' + data.id);
                    form.reset();
                    categoriaForm.style.display = 'none';
                    btnMostrarForm.disabled = false;
                    document.getElementById('filtroCampo').disabled = false;
                    document.getElementById('ordenCampo').disabled = false;
                    document.getElementById('busqueda').disabled = false;
                    document.getElementById('tablaCategorias').classList.remove('table-disabled');
                    cargarCategorias();
                    modoEdicion = false;
                    idEdicion = null;
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(function(err) { alert('Error de conexi√≥n: ' + err.message); });
    });

    document.getElementById('nombre').addEventListener('input', function() {
        const nombre = this.value;
        const regex = /^[\w\s√°√©√≠√≥√∫√Å√â√ç√ì√ö√º√ú√±√ë.,-]{1,100}$/;
        const errorSpan = document.getElementById('nombreError');
        if (!regex.test(nombre)) {
            errorSpan.textContent = 'Solo letras, n√∫meros y algunos signos permitidos. M√°x 100 caracteres.';
            this.classList.add('is-invalid');
        } else {
            errorSpan.textContent = '';
            this.classList.remove('is-invalid');
        }
    });

    window.verCategoria = function(id) {
        const cat = categorias.find(c => c.id_categoria === id);
        if (cat) {
            categoriaForm.style.display = 'flex';
            document.getElementById('formTitulo').textContent = 'Consultar categor√≠a';
            btnMostrarForm.disabled = true;
            document.getElementById('filtroCampo').disabled = true;
            document.getElementById('ordenCampo').disabled = true;
            document.getElementById('busqueda').disabled = true;
            document.getElementById('tablaCategorias').classList.add('table-disabled');
            document.getElementById('nombre').value = cat.nombre;
            document.getElementById('descripcion').value = cat.descripcion;
            document.getElementById('id_categoria_padre').value = cat.id_categoria_padre ?? '';
            document.getElementById('nombre').disabled = true;
            document.getElementById('descripcion').disabled = true;
            document.getElementById('id_categoria_padre').disabled = true;
            categoriaForm.querySelector('button[type="submit"]').disabled = true;
            btnCancelarForm.disabled = false;
        }
    }
    window.editarCategoria = function(id) {
        const cat = categorias.find(c => c.id_categoria === id);
        if (cat) {
            modoEdicion = true;
            idEdicion = id;
            categoriaForm.style.display = 'flex';
            document.getElementById('formTitulo').textContent = 'Editar categor√≠a';
            btnMostrarForm.disabled = true;
            document.getElementById('filtroCampo').disabled = true;
            document.getElementById('ordenCampo').disabled = true;
            document.getElementById('busqueda').disabled = true;
            document.getElementById('tablaCategorias').classList.add('table-disabled');
            document.getElementById('nombre').value = cat.nombre;
            document.getElementById('descripcion').value = cat.descripcion;
            document.getElementById('id_categoria_padre').value = cat.id_categoria_padre ?? '';
        }
    }
    window.eliminarCategoria = function(id) {
        if (confirm('¬øEliminar categor√≠a?')) {
            apiFetch('../Controllers/categoria_api.php?id=' + id, {
                method: 'DELETE'
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Categor√≠a eliminada');
                    cargarCategorias();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(err => console.error('Error al eliminar categor√≠a:', err));
        }
    }
    cargarCategorias();
    </script>
</body>
</html>
<style>
.table-disabled {
    pointer-events: none;
    opacity: 0.5;
}
</style>
